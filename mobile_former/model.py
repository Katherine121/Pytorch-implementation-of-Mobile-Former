import torch
import torch.nn as nn

from torch.nn import init
import torch.nn.functional as F

from mobile_former.mobile import Mobile, MobileDown
from mobile_former.former import Former
from mobile_former.bridge import Former2Mobile


class hswish(nn.Module):
    def forward(self, x):
        out = x * F.relu6(torch.add(x, 3.0)) / 6.0
        return out


class BaseBlock(nn.Module):
    def __init__(self, inp, exp, out, se, stride, heads, dim):
        super(BaseBlock, self).__init__()
        if stride == 2:
            self.mobile = MobileDown(3, inp, exp, out, stride)
        else:
            self.mobile = Mobile(3, inp, exp, out, stride)
        self.former = Former(dim=dim)
        self.former2mobile = Former2Mobile(dim=dim, heads=heads, channel=out)

    def forward(self, x, z):
        z_out = self.former(z)
        x_hid = self.mobile(x)
        x_out = self.former2mobile(x_hid, z_out)
        return x_out, z_out


class MobileFormer(nn.Module):
    def __init__(self, cfg):
        super(MobileFormer, self).__init__()
        # 初始化6*192token
        self.token = nn.Parameter(nn.Parameter(torch.randn(1, cfg['token'], cfg['embed'])))

        # stem 3 224 224 -> 16 112 112
        self.stem = nn.Sequential(
            nn.Conv2d(3, cfg['stem'], kernel_size=3, stride=2, padding=1, bias=False),
            nn.BatchNorm2d(cfg['stem']),
            hswish()
        )
        # bneck 先*2后还原，步长为1，组卷积
        self.bneck = nn.Sequential(
            nn.Conv2d(cfg['stem'], cfg['bneck']['e'], kernel_size=3, stride=cfg['bneck']['s'], padding=1,
                      groups=cfg['stem']),
            hswish(),
            nn.Conv2d(cfg['bneck']['e'], cfg['bneck']['o'], kernel_size=1, stride=1),
            nn.BatchNorm2d(cfg['bneck']['o'])
        )

        # body
        self.block = nn.ModuleList()
        for kwargs in cfg['body']:
            # 把{'inp': 12, 'exp': 72, 'out': 16, 'stride': 2, 'heads': 2}和token维度192传进去
            self.block.append(BaseBlock(**kwargs, dim=cfg['embed']))

        inp = cfg['body'][-1]['out']
        exp = cfg['body'][-1]['exp']
        self.conv = nn.Conv2d(inp, exp, kernel_size=1, stride=1, padding=0, bias=False)
        self.bn = nn.BatchNorm2d(exp)
        self.avg = nn.AvgPool2d((7, 7))

        self.head1 = nn.Linear(exp + cfg['embed'], cfg['fc1'])
        self.tanh = hswish()
        self.head2 = nn.Linear(cfg['fc1'], cfg['fc2'])

        self.init_params()

    def init_params(self):
        for m in self.modules():
            if isinstance(m, nn.Conv2d):
                init.kaiming_normal_(m.weight, mode='fan_out')
                if m.bias is not None:
                    init.constant_(m.bias, 0)
            elif isinstance(m, nn.BatchNorm2d):
                init.constant_(m.weight, 1)
                init.constant_(m.bias, 0)
            elif isinstance(m, nn.Linear):
                init.normal_(m.weight, std=0.001)
                if m.bias is not None:
                    init.constant_(m.bias, 0)

    def forward(self, x):
        # batch_size
        b = x.shape[0]
        # 因为最开始初始化的是1*6*192，在0维度重复b次，1维度重复1次，2维度重复1次，就形成了b*6*192
        # z = self.token.repeat(b, 1, 1)
        token = torch.Tensor([[[8.8654e-03, -6.5715e-03, 6.9266e-04, -4.6680e-02, -1.9801e-03,
                                1.2004e-01, -1.2897e-02, 1.2513e-03, 2.9396e-03, -3.2895e-03,
                                9.8281e-04, -2.6390e-02, -9.9611e-04, 5.3227e-03, -1.9053e-02,
                                4.8873e-04, 3.4113e-03, -1.6212e-02, -7.5686e-03, 7.0529e-03,
                                -5.8256e-03, -4.3689e-03, -4.7999e-03, -1.1045e-02, -2.4969e-03,
                                -4.1204e-03, -3.8329e-03, -1.0676e-02, -9.7432e-03, 2.9955e-03,
                                2.8248e-03, -9.3940e-03, -1.8833e-03, 6.4204e-03, -1.6107e-02,
                                3.5534e-03, -6.4039e-03, -1.6652e-02, -2.1566e-03, 6.0793e-03,
                                6.5710e-04, -3.0835e-03, 1.6722e-03, -4.6664e-03, -5.7065e-03,
                                -6.2369e-03, 4.7679e-03, -3.0903e-03, -8.1770e-03, 3.0141e-03,
                                -3.1424e-02, -2.2187e-04, -2.9620e-03, 7.2881e-04, -1.2727e-02,
                                8.0434e-03, -7.8306e-03, -6.9615e-04, 4.2282e-03, -1.2187e-02,
                                -6.4588e-03, -6.4791e-03, -2.5172e-03, -6.0020e-03, -9.6572e-03,
                                3.5199e-03, 1.7575e-04, -3.3742e-03, -1.5959e-03, -2.0246e-02,
                                -3.1013e-03, -6.6153e-03, -4.6842e-03, 1.1447e-02, -8.4428e-03,
                                -4.4842e-03, -5.8462e-03, -3.8478e-03, -1.0225e-02, 1.1390e-02,
                                -9.9844e-04, -1.1000e-02, -7.9481e-03, 1.6758e-03, 2.9895e-03,
                                -6.8646e-03, -6.4191e-03, 3.8414e-04, 1.6589e-05, -6.5451e-03,
                                1.4464e-03, 5.0283e-03, -5.1353e-03, -1.5846e-02, -8.2776e-04,
                                -1.1275e-02, -2.3105e-03, -1.2442e-02, -1.5410e-02, 7.8206e-03,
                                -4.5996e-03, -3.8937e-03, -4.3493e-03, -8.0063e-03, -3.7364e-03,
                                -4.8293e-03, -1.5290e-03, -3.6448e-04, -6.7766e-03, 3.8093e-03,
                                1.8851e-03, -2.1145e-03, -1.7037e-03, -1.0882e-02, -1.1064e-02,
                                -6.5802e-03, -6.1423e-03, 1.5032e-03, -3.6141e-04, -3.3473e-03,
                                -1.5376e-02, -4.3706e-03, -7.3956e-03, 1.8244e-04, -7.8258e-03,
                                -5.0768e-03, 4.0107e-03, -1.4110e-02, -2.5831e-03, -4.2565e-03,
                                -7.9975e-03, -4.6807e-06, -1.3450e-02, -1.3891e-02, 9.2616e-04,
                                1.8598e-04, -4.5867e-03, -2.3493e-03, -1.1680e-02, -8.6549e-03,
                                -1.1569e-02, 1.9628e-03, -1.5272e-02, -5.7453e-03, 5.0869e-03,
                                -9.3431e-03, -2.4761e-03, 4.5308e-03, -8.4909e-03, -1.3964e-03,
                                -1.4830e-02, -2.4249e-03, 2.2883e-03, -1.3714e-02, -9.5764e-03,
                                5.7868e-03, -7.3147e-03, 6.2002e-03, 1.8466e-02, -5.6848e-03,
                                -9.3737e-03, -2.2734e-02, 1.8334e-03, -1.1769e-02, -2.4745e-04,
                                6.9403e-03, -1.1543e-02, 1.3456e-03, 2.6104e-03, 8.1753e-03,
                                -4.6080e-03, -1.5113e-02, -5.9981e-03, -1.0409e-02, -9.2424e-03,
                                -2.5798e-03, -9.7994e-03, -1.3814e-02, -6.7844e-04, -1.3924e-02,
                                1.6186e-03, -5.3271e-03, -4.3506e-03, -2.5525e-03, -3.7190e-03,
                                -1.2668e-02, 3.4163e-03, -1.0014e-02, 2.7343e-03, -2.1206e-02,
                                -1.7815e-02, 2.8363e-01],
                               [1.4150e-02, 1.4399e-02, 2.8223e-02, 6.4770e-02, 1.9958e-02,
                                -3.4367e-02, 1.6639e-02, 2.2418e-02, 3.3717e-02, 2.2763e-02,
                                1.9984e-02, 5.1157e-02, -4.4412e-04, -1.2193e-02, 5.8013e-02,
                                1.5511e-02, 1.8826e-02, 3.5622e-02, 2.4578e-02, 4.3960e-02,
                                1.9603e-02, 2.1626e-02, 3.1013e-02, 3.3818e-02, -1.0792e-03,
                                1.4602e-02, 5.3094e-02, 2.7792e-02, 3.2958e-02, 1.3990e-02,
                                2.1632e-02, 2.7659e-02, 3.4560e-02, -9.2746e-03, 3.6484e-02,
                                5.6350e-03, 9.1896e-03, 3.4457e-02, 6.8951e-03, 4.2962e-02,
                                1.9418e-02, 1.2715e-02, 3.5357e-02, 1.8339e-02, 9.9157e-03,
                                1.5107e-02, 1.1452e-02, 7.3462e-03, 4.8423e-03, 1.7375e-02,
                                3.8021e-02, -1.5437e-02, 5.6696e-02, 2.3588e-02, -7.6409e-03,
                                7.7944e-03, 1.7729e-02, 2.5095e-02, 1.9654e-02, 4.0001e-02,
                                2.7530e-02, 5.6988e-03, 7.9319e-03, 1.0530e-02, 1.8954e-02,
                                6.5995e-03, -6.9940e-02, 7.1495e-03, -3.0962e-03, 3.3321e-02,
                                1.6075e-02, -3.5880e-02, 4.3164e-02, 3.7762e-01, 1.8425e-02,
                                1.3148e-03, 1.4635e-02, 2.6317e-02, 2.9175e-02, 4.7894e-03,
                                2.5080e-02, 1.2120e-02, 4.3679e-03, 8.3542e-03, 2.1256e-02,
                                2.7206e-02, -2.8080e-03, 2.9702e-02, 6.4380e-03, 2.7270e-02,
                                -1.2633e-02, 1.3857e-02, 8.5345e-03, -8.7463e-03, 1.1606e-02,
                                1.5655e-02, 6.4366e-03, 2.8541e-02, 2.5818e-02, 1.7284e-02,
                                3.5917e-02, 1.5789e-04, 7.3030e-04, 3.5365e-01, -1.2457e-02,
                                1.4219e-02, 8.5465e-03, 5.3316e-03, 1.1373e-02, 3.7885e-02,
                                -1.3213e-02, 1.6842e-01, 3.7446e-02, 1.0279e-02, 2.4750e-02,
                                1.4211e-02, 2.9158e-02, -2.8296e-03, 6.8395e-03, 2.9385e-02,
                                1.0936e-02, 1.8468e-02, 1.0485e-02, 9.3585e-03, 5.8058e-03,
                                5.7224e-03, 2.5545e-02, 4.7702e-02, 3.2027e-02, 8.5185e-03,
                                2.7397e-02, 4.5611e-03, 2.2513e-02, 6.1781e-02, -9.7055e-03,
                                2.0561e-02, 2.4458e-02, -2.6875e-03, 1.8927e-02, 1.8759e-02,
                                3.1159e-03, 2.4268e-02, 7.1226e-02, 3.7364e-03, -1.2505e-03,
                                3.7483e-02, 1.5525e-02, 1.3370e-02, -8.9029e-03, 2.4324e-02,
                                4.7852e-02, 2.0947e-02, 1.9098e-02, 4.3739e-02, 4.0552e-02,
                                1.3205e-02, 1.8345e-02, -2.1444e-03, -3.4458e-02, 2.0327e-02,
                                2.3326e-02, 3.8414e-02, 1.1058e-02, 1.4829e-02, 3.7573e-02,
                                3.7230e-02, 1.6503e-02, 2.7944e-02, 2.4664e-02, 2.1956e-03,
                                4.4464e-03, -3.6279e-04, 4.0744e-03, 3.6075e-02, 8.3708e-03,
                                1.0590e-03, 2.7284e-02, 2.5145e-02, 3.1096e-02, 3.7339e-02,
                                1.7220e-02, 1.3666e-02, 1.0805e-02, 2.0514e-02, 2.8505e-02,
                                7.4520e-03, 1.2675e-02, 2.2869e-02, 2.1101e-02, 3.6867e-02,
                                4.0261e-02, -3.1133e-01],
                               [-1.3055e-02, -1.5614e-02, -2.6923e-02, -1.0981e-01, -5.1558e-03,
                                1.8826e-01, -1.6980e-02, -1.2229e-02, -3.0211e-02, -2.8550e-02,
                                -1.6976e-02, -7.0012e-02, 9.8233e-03, 5.3677e-03, -6.2917e-02,
                                -1.7829e-02, -4.0562e-03, -4.2627e-02, -5.0669e-03, -3.2166e-02,
                                3.1799e-03, -3.8739e-02, -2.0677e-02, -3.9915e-03, 1.7327e-03,
                                -6.4446e-03, -4.0592e-02, -1.8935e-02, -2.8487e-02, 4.1857e-03,
                                -1.6062e-02, -2.1224e-02, -2.9578e-02, 2.3773e-02, -4.2274e-02,
                                -6.1099e-03, -2.1406e-02, -2.0957e-02, -1.4792e-02, -2.3291e-02,
                                -2.9714e-04, -5.0076e-03, -2.1659e-02, -3.5335e-02, -2.4916e-03,
                                -1.3057e-02, -9.9159e-03, -9.7593e-03, 2.7259e-03, -5.2853e-03,
                                -6.9471e-02, 5.3157e-03, -3.0508e-02, -1.6567e-02, 1.8235e-02,
                                -1.0213e-02, -1.8842e-02, -2.6586e-02, -2.8981e-02, -2.9358e-02,
                                -2.6606e-02, 8.9889e-03, -2.4610e-03, -9.6534e-03, -7.8591e-03,
                                -1.2791e-02, 6.1025e-02, 5.1530e-03, -6.9153e-03, -4.5250e-02,
                                -5.3180e-03, 2.4358e-02, -3.3982e-02, -3.9064e-01, -7.4776e-03,
                                -1.3127e-02, -1.8056e-02, -2.6368e-02, -1.5987e-02, 8.7925e-03,
                                -1.1114e-02, -1.4436e-02, -3.8503e-03, -1.1079e-02, 1.3354e-03,
                                -2.4044e-02, 3.2215e-03, -2.1605e-02, -4.7389e-03, -1.2724e-02,
                                1.9009e-02, -1.7113e-03, -1.0784e-02, 1.1196e-02, -8.5256e-04,
                                -1.7742e-02, 2.4192e-03, -2.7569e-02, -4.2980e-02, -1.7983e-02,
                                -2.4764e-02, 5.7886e-03, 7.5789e-03, -3.4930e-01, 6.6080e-03,
                                -1.5858e-02, -1.7737e-02, -1.2582e-02, -2.2349e-03, -3.6990e-02,
                                9.0380e-03, -1.5247e-01, -3.1564e-02, 2.4561e-03, -1.2308e-02,
                                -1.3442e-02, -2.3069e-02, -3.4241e-03, 4.4019e-03, -4.4417e-02,
                                -8.0909e-03, -9.4277e-03, -1.2566e-02, -8.4256e-03, -7.1744e-03,
                                -8.1992e-03, -1.3532e-02, -4.4583e-02, -2.8213e-02, 4.2076e-03,
                                -1.8183e-02, -1.0935e-02, -2.1966e-02, -5.7603e-02, -1.8800e-03,
                                -1.4916e-02, -3.0072e-02, -5.5773e-03, -3.0486e-02, -2.1717e-03,
                                8.3171e-03, -1.4963e-02, -6.6254e-02, 1.8118e-03, -8.6268e-03,
                                -4.7233e-02, -1.2123e-02, 3.3525e-03, 3.0087e-03, -1.5566e-02,
                                -5.1259e-02, -1.7667e-04, -1.4892e-02, -4.2129e-02, -4.3858e-02,
                                2.1484e-03, -2.0665e-03, 1.9012e-02, 4.2674e-02, -1.6428e-02,
                                -1.8856e-02, -4.5624e-02, -3.4906e-03, -1.1529e-02, -3.5475e-02,
                                -1.5472e-02, -1.1961e-02, -1.6997e-02, -9.6432e-03, 7.2284e-03,
                                -1.2069e-02, -6.4252e-03, -1.8502e-02, -2.6555e-02, -1.2669e-02,
                                6.6085e-03, -1.7599e-02, -2.3768e-02, -2.5639e-02, -2.3729e-02,
                                6.2260e-03, -1.7482e-02, -8.3808e-03, -1.4188e-02, -3.2977e-02,
                                -2.6616e-03, -1.7582e-02, -3.2252e-02, 3.0011e-03, -4.3030e-02,
                                -3.6313e-02, -1.0279e-01],
                               [3.7537e-02, 1.9915e-02, 3.2318e-02, -5.5286e-02, 4.1984e-02,
                                1.7767e-01, 1.7743e-02, 3.5345e-02, 4.6606e-02, 3.2249e-02,
                                3.0865e-02, -1.0347e-02, 4.4660e-02, 2.0757e-02, -5.0335e-03,
                                4.0972e-02, 3.5044e-02, 1.1443e-02, 2.4339e-02, 3.7852e-02,
                                3.6235e-02, 2.6701e-03, 1.7005e-02, 4.0299e-02, 3.1012e-02,
                                2.6621e-02, 4.6989e-02, 3.1899e-02, 2.3867e-02, 4.4150e-02,
                                2.1118e-02, -9.4700e-03, 3.4775e-02, 4.8449e-02, 4.8086e-03,
                                2.5909e-02, 5.8765e-03, 3.5152e-02, 3.9814e-02, -1.7430e-02,
                                2.9342e-02, 2.1873e-02, 3.1751e-02, 3.0014e-02, 4.1663e-02,
                                2.8622e-02, 2.6426e-02, 2.2569e-02, 2.8897e-02, 3.2813e-02,
                                -3.4029e-02, 2.2896e-02, 2.8489e-02, 4.9154e-02, 2.7239e-02,
                                1.9647e-02, 2.8897e-02, 3.5422e-02, 4.5197e-02, -8.0557e-03,
                                1.3541e-02, 4.3490e-02, 2.2874e-02, 3.7709e-02, 3.1523e-02,
                                3.4436e-02, 4.5183e-02, 2.9563e-02, 3.2268e-02, -1.1491e-02,
                                1.7689e-02, 2.1240e-02, 1.5174e-02, -2.3395e-01, 4.0050e-02,
                                2.7147e-02, 3.7552e-02, 3.0353e-02, 1.7099e-02, 5.2031e-02,
                                2.4290e-02, 2.7806e-02, 3.1312e-02, 4.8588e-02, 2.6318e-02,
                                3.6041e-02, 2.7515e-02, 2.2780e-02, 3.3341e-02, 2.8402e-02,
                                2.5891e-02, 3.3637e-02, 1.2157e-02, 7.2189e-03, 2.2310e-02,
                                3.3999e-03, 3.3222e-02, 3.0591e-02, 6.8085e-03, 2.3388e-02,
                                6.0144e-02, 2.8827e-02, 2.5287e-02, -2.9265e-02, 2.0594e-02,
                                4.0347e-02, -2.0485e-02, 4.0595e-02, 2.6061e-02, 1.0840e-02,
                                2.8023e-02, 2.8819e-01, 2.3993e-02, 1.7705e-02, 1.9231e-02,
                                1.6142e-02, 3.1510e-02, 2.2761e-02, 4.2377e-02, 2.2326e-02,
                                2.3197e-02, 2.3297e-02, 2.9713e-02, 2.1157e-02, 2.1208e-02,
                                3.1418e-02, 3.2445e-02, 1.5261e-02, 2.9444e-02, 3.3009e-02,
                                2.3322e-02, 1.0876e-02, 3.9342e-03, 6.7070e-03, 3.2225e-02,
                                3.5605e-02, 2.1460e-03, 2.3480e-02, 1.8904e-02, 4.0343e-02,
                                3.2067e-02, 1.3236e-02, 1.0204e-02, 3.2697e-02, 4.3449e-02,
                                1.1833e-02, 1.9937e-02, 3.1035e-02, 8.7361e-03, 3.8213e-02,
                                7.4347e-03, 2.1376e-02, 2.5117e-02, 2.3771e-02, 3.3845e-02,
                                3.4343e-02, 4.8595e-02, 3.4332e-02, 5.0311e-02, 2.7260e-02,
                                2.6362e-02, -4.4699e-03, 2.9729e-02, 3.1555e-02, 3.4110e-02,
                                4.0368e-02, 1.9967e-02, 3.9177e-02, 3.1423e-02, 4.0488e-02,
                                2.3026e-02, 2.3568e-03, 1.8584e-02, 2.9894e-02, 3.5735e-02,
                                1.5382e-02, 1.2637e-02, 2.6927e-02, 2.8918e-02, 2.6647e-02,
                                4.4127e-02, 4.0846e-02, 4.0405e-02, 4.2694e-02, 4.7835e-02,
                                1.3111e-02, 1.8814e-02, 2.2102e-02, 4.1504e-02, 5.7094e-03,
                                6.2229e-03, 1.9472e-01],
                               [2.9974e-02, 1.2327e-03, 3.6146e-02, -5.8888e-02, 2.3331e-02,
                                1.6545e-01, 2.3232e-02, 3.3514e-02, 2.3382e-02, 1.3328e-02,
                                2.5006e-02, -1.6588e-02, 3.9795e-02, 3.0313e-02, -1.0870e-02,
                                1.6473e-02, 2.0510e-02, 1.3650e-02, 2.8584e-02, 2.5039e-02,
                                1.4904e-02, 2.0639e-02, 1.1969e-02, 1.7974e-02, 2.6126e-02,
                                4.6755e-03, 1.5446e-02, 6.4570e-03, -1.0633e-03, 2.4314e-02,
                                2.8175e-02, 2.1990e-02, 1.8349e-02, 4.3190e-02, -1.1483e-02,
                                3.2588e-02, 3.1494e-02, 1.3265e-02, 1.9598e-02, 1.1543e-02,
                                1.8974e-02, 1.9735e-02, 1.8413e-02, 1.9772e-02, 4.1458e-02,
                                2.7660e-02, 2.4986e-02, 2.8966e-02, 1.6600e-02, 1.3243e-02,
                                -3.2608e-02, 2.4214e-02, 3.6545e-02, 1.4372e-02, 2.5315e-02,
                                3.8553e-02, 1.9198e-02, 3.3808e-03, 2.0458e-02, 1.3067e-02,
                                1.2991e-02, 1.6469e-02, 2.2621e-02, 1.7553e-02, 2.6368e-02,
                                1.5769e-02, -2.7365e-03, 2.8127e-02, 4.0431e-03, -1.5325e-02,
                                3.6749e-02, 1.2414e-02, 2.8413e-02, 9.4070e-02, 3.2764e-02,
                                1.0423e-02, 1.7566e-02, 3.3527e-02, 3.2814e-02, 3.7073e-02,
                                3.6738e-02, 3.6766e-03, 1.9380e-02, 1.8802e-02, 6.1471e-03,
                                8.6854e-03, 4.2826e-02, 2.0403e-02, 3.1236e-02, 2.0824e-02,
                                3.2562e-02, 2.9051e-02, 1.4004e-02, 3.3638e-02, 2.1876e-02,
                                1.0529e-02, 1.5735e-02, 1.4343e-02, -7.7578e-03, 2.8611e-02,
                                1.5786e-02, 2.1949e-02, 4.2378e-02, 3.3870e-02, 1.1679e-02,
                                7.5742e-03, 2.6564e-02, 2.4351e-02, 1.8896e-02, 3.0064e-02,
                                2.1923e-02, -2.7080e-01, 8.8145e-03, 3.4667e-02, 1.5376e-02,
                                2.6015e-02, 3.7654e-02, 7.7907e-03, 2.8261e-02, 3.4075e-03,
                                5.8787e-03, 3.2933e-02, 1.7005e-02, 1.7422e-02, 2.3261e-02,
                                2.8109e-03, 2.5014e-02, 2.8189e-02, 1.6831e-02, 1.5645e-02,
                                3.0899e-02, 1.9569e-02, 6.3519e-03, 5.1850e-03, 1.2670e-02,
                                1.1623e-02, 8.8935e-03, 1.0773e-03, 1.3966e-02, 4.7938e-03,
                                2.1951e-02, 1.8741e-02, 6.0225e-03, 6.3169e-03, 4.2009e-02,
                                1.1288e-02, 1.6029e-02, 2.4384e-02, 2.4180e-02, 3.1405e-02,
                                1.2813e-02, 2.2812e-02, 3.2783e-02, -2.0003e-04, 9.3790e-03,
                                4.0348e-02, 3.3339e-02, 2.7478e-02, 3.9909e-02, 1.7444e-02,
                                1.5921e-02, -1.0072e-02, 3.1080e-02, 1.4635e-02, 2.3746e-02,
                                1.3248e-02, 8.0681e-03, 1.4876e-02, 4.5724e-02, 2.3065e-02,
                                1.9535e-02, 1.5297e-02, 1.6462e-02, 2.1134e-02, 2.9766e-02,
                                2.8615e-02, 2.4559e-02, 8.8712e-03, 3.3078e-02, 1.7536e-02,
                                2.4865e-02, -2.2939e-04, 8.9380e-03, 5.1314e-03, 1.1390e-02,
                                2.1405e-02, 1.3810e-02, 1.7072e-02, 2.8341e-02, 1.1727e-02,
                                -2.2756e-03, 2.4457e-01],
                               [-4.0708e-02, -2.5657e-02, -6.3288e-02, 2.9766e-02, -6.3270e-02,
                                -6.3116e-02, -5.4415e-02, -5.4302e-02, -6.1114e-02, -4.3629e-02,
                                -4.8162e-02, -1.3541e-02, -6.3261e-02, -6.1817e-02, 3.9567e-03,
                                -5.6003e-02, -3.2576e-02, -2.8502e-02, -4.7356e-02, -2.7578e-02,
                                -4.5839e-02, -3.6927e-02, -3.1818e-02, -3.7463e-02, -5.1351e-02,
                                -3.1380e-02, -6.6760e-02, -5.2403e-02, -2.7203e-02, -5.0571e-02,
                                -4.2740e-02, -1.9118e-02, -5.5624e-02, -6.3465e-02, 1.8239e-03,
                                -5.6032e-02, -4.3770e-02, -4.4953e-02, -6.2212e-02, 3.1701e-02,
                                -3.4324e-02, -4.6616e-02, -4.1367e-02, -5.1514e-02, -8.3391e-02,
                                -5.3780e-02, -4.4598e-02, -6.4248e-02, -4.7208e-02, -3.6587e-02,
                                1.6174e-02, -5.7711e-02, -4.6484e-02, -6.4480e-02, -4.2215e-02,
                                -5.9688e-02, -4.7046e-02, -4.4149e-02, -6.4809e-02, 5.0764e-03,
                                -3.2540e-02, -5.1809e-02, -5.0526e-02, -6.7395e-02, -4.6423e-02,
                                -5.9726e-02, -4.2173e-02, -5.1742e-02, -4.6995e-02, -1.7656e-04,
                                -4.0776e-02, -5.4391e-02, -4.2330e-02, 1.3152e-01, -5.9575e-02,
                                -5.8417e-02, -5.0379e-02, -6.2774e-02, -4.5905e-02, -7.1403e-02,
                                -4.8823e-02, -5.0226e-02, -5.2578e-02, -5.9442e-02, -1.4581e-02,
                                -3.9371e-02, -7.2687e-02, -2.8591e-02, -6.4353e-02, -3.7465e-02,
                                -5.1528e-02, -4.5814e-02, -3.2472e-02, -4.9937e-02, -3.2548e-02,
                                -2.8657e-02, -4.1442e-02, -5.0770e-02, -3.2808e-02, -4.2497e-02,
                                -7.1535e-02, -4.7743e-02, -5.4657e-02, -2.9437e-03, -5.3105e-02,
                                -5.8392e-02, -1.6315e-02, -7.7267e-02, -5.6173e-02, -3.2703e-02,
                                -5.7164e-02, -1.6867e-02, -2.4854e-02, -5.3221e-02, -4.0646e-02,
                                -5.2595e-02, -7.2863e-02, -4.0404e-02, -6.3559e-02, -3.7019e-02,
                                -3.9266e-02, -4.4921e-02, -5.5765e-02, -4.2696e-02, -5.7510e-02,
                                -5.1279e-02, -3.9379e-02, -4.6823e-02, -4.7727e-02, -4.8346e-02,
                                -4.9216e-02, -4.1494e-02, -2.6335e-02, -2.2314e-02, -6.1092e-02,
                                -5.0418e-02, -2.6474e-02, -2.8670e-02, -4.7262e-02, -3.9668e-02,
                                -5.0788e-02, -1.7788e-02, -2.0161e-02, -3.8632e-02, -8.1801e-02,
                                -4.0993e-02, -3.6315e-02, -3.9719e-02, -4.9372e-02, -6.2046e-02,
                                -3.8739e-02, -3.7599e-02, -5.2135e-02, -4.2094e-02, -5.4392e-02,
                                -6.8707e-02, -5.2162e-02, -3.5016e-02, -6.1366e-02, -4.1771e-02,
                                -3.7032e-02, -1.4502e-02, -4.2081e-02, -4.7615e-02, -6.4720e-02,
                                -2.5146e-02, -3.0175e-02, -5.5058e-02, -6.0958e-02, -4.9250e-02,
                                -4.9489e-02, -4.5728e-02, -4.8892e-02, -5.1876e-02, -8.2607e-02,
                                -4.1205e-02, -3.6047e-02, -5.2076e-02, -6.5985e-02, -4.8794e-02,
                                -5.4413e-02, -4.0959e-02, -4.8510e-02, -4.4655e-02, -6.9108e-02,
                                -4.2127e-02, -3.8505e-02, -5.3892e-02, -3.9453e-02, -3.8012e-02,
                                -2.1884e-02, -5.5970e-01]]])

        z = token
        for i in range(b - 1):
            z = torch.cat((z, token), dim=0)

        x = self.bneck(self.stem(x))
        for m in self.block:
            x, z = m(x, z)

        # 转成b个平铺一维向量
        x = self.avg(self.bn(self.conv(x))).view(b, -1)
        # 取第一个token
        z = z[:, 0, :].view(b, -1)
        # 最后一个维度拼接
        out = torch.cat((x, z), -1)

        out = self.head1(out)
        out = self.tanh(out)
        out = self.head2(out)
        return out
