import torch
import torch.nn as nn

from torch.nn import init
import torch.nn.functional as F

from mobile_former.mobile import Mobile, MobileDown
from mobile_former.former import Former
from mobile_former.bridge import Former2Mobile


class hswish(nn.Module):
    def forward(self, x):
        out = x * F.relu6(torch.add(x, 3.0)) / 6.0
        return out


class BaseBlock(nn.Module):
    def __init__(self, inp, exp, out, se, stride, heads, dim):
        super(BaseBlock, self).__init__()
        if stride == 2:
            self.mobile = MobileDown(3, inp, exp, out, stride)
        else:
            self.mobile = Mobile(3, inp, exp, out, stride)
        self.former = Former(dim=dim)
        self.former2mobile = Former2Mobile(dim=dim, heads=heads, channel=out)

    def forward(self, x, z):
        z_out = self.former(z)
        x_hid = self.mobile(x)
        x_out = self.former2mobile(x_hid, z_out)
        return x_out, z_out


class MobileFormer(nn.Module):
    def __init__(self, cfg):
        super(MobileFormer, self).__init__()
        # 初始化6*192token
        self.token = nn.Parameter(nn.Parameter(torch.randn(1, cfg['token'], cfg['embed'])))

        # stem 3 224 224 -> 16 112 112
        self.stem = nn.Sequential(
            nn.Conv2d(3, cfg['stem'], kernel_size=3, stride=2, padding=1, bias=False),
            nn.BatchNorm2d(cfg['stem']),
            hswish()
        )
        # bneck 先*2后还原，步长为1，组卷积
        self.bneck = nn.Sequential(
            nn.Conv2d(cfg['stem'], cfg['bneck']['e'], kernel_size=3, stride=cfg['bneck']['s'], padding=1,
                      groups=cfg['stem']),
            hswish(),
            nn.Conv2d(cfg['bneck']['e'], cfg['bneck']['o'], kernel_size=1, stride=1),
            nn.BatchNorm2d(cfg['bneck']['o'])
        )

        # body
        self.block = nn.ModuleList()
        for kwargs in cfg['body']:
            # 把{'inp': 12, 'exp': 72, 'out': 16, 'stride': 2, 'heads': 2}和token维度192传进去
            self.block.append(BaseBlock(**kwargs, dim=cfg['embed']))

        inp = cfg['body'][-1]['out']
        exp = cfg['body'][-1]['exp']
        self.conv = nn.Conv2d(inp, exp, kernel_size=1, stride=1, padding=0, bias=False)
        self.bn = nn.BatchNorm2d(exp)
        self.avg = nn.AvgPool2d((7, 7))

        self.head1 = nn.Linear(exp + cfg['embed'], cfg['fc1'])
        self.tanh = hswish()
        self.head2 = nn.Linear(cfg['fc1'], cfg['fc2'])

        self.init_params()

    def init_params(self):
        for m in self.modules():
            if isinstance(m, nn.Conv2d):
                init.kaiming_normal_(m.weight, mode='fan_out')
                if m.bias is not None:
                    init.constant_(m.bias, 0)
            elif isinstance(m, nn.BatchNorm2d):
                init.constant_(m.weight, 1)
                init.constant_(m.bias, 0)
            elif isinstance(m, nn.Linear):
                init.normal_(m.weight, std=0.001)
                if m.bias is not None:
                    init.constant_(m.bias, 0)

    def forward(self, x):
        # batch_size
        b = x.shape[0]
        # 因为最开始初始化的是1*6*192，在0维度重复b次，1维度重复1次，2维度重复1次，就形成了b*6*192
        z = self.token.repeat(b, 1, 1)
        token = torch.Tensor([[[5.8933e-03, -7.7364e-03, 2.6507e-03, -4.9257e-02, -2.8715e-03,
                                1.6136e-01, 3.9643e-03, -1.9035e-03, 5.4351e-03, -1.8706e-02,
                                7.5676e-03, -3.2774e-02, 2.6765e-03, -2.8665e-03, -3.2080e-02,
                                -8.9862e-03, -1.8967e-03, -1.0609e-02, -9.8131e-04, -4.9654e-03,
                                -7.8759e-04, 5.2325e-04, -6.3954e-03, -8.5004e-03, -5.7530e-03,
                                -8.8919e-03, -9.9592e-03, 1.6307e-04, -7.3844e-03, -4.6102e-03,
                                -7.9829e-03, 2.2841e-03, -6.0137e-03, 1.4008e-03, -2.8336e-02,
                                9.5833e-04, -6.7817e-03, -1.9834e-03, 7.3401e-03, -1.5129e-02,
                                -1.2056e-03, -7.7493e-03, -9.7596e-03, -4.0309e-04, -1.6410e-02,
                                1.5323e-02, -8.8083e-03, -5.7686e-03, -1.6272e-02, -6.1175e-04,
                                -3.5978e-02, -9.6749e-03, -3.6666e-03, -9.2931e-03, -2.3613e-03,
                                -8.0844e-03, -2.5542e-03, 9.3429e-04, -3.1872e-04, -1.8831e-02,
                                1.5778e-03, 1.7153e-02, 1.9936e-03, 2.6577e-04, -1.1747e-02,
                                7.0804e-03, 7.8345e-04, 2.8659e-03, 1.1619e-02, -3.6619e-02,
                                -1.9795e-03, 3.1782e-03, -1.7337e-03, 2.5083e-02, 5.8676e-03,
                                -1.6559e-03, -1.1246e-02, -4.5220e-03, -2.5698e-04, 8.5734e-03,
                                -7.6582e-03, -1.0722e-02, 1.0781e-02, -4.4425e-03, -3.3059e-03,
                                7.1793e-03, 7.1733e-03, -6.9186e-03, -4.3021e-03, -6.3508e-03,
                                3.3036e-03, -9.6176e-03, -2.6050e-03, -1.7980e-02, 6.5267e-03,
                                -3.2703e-03, -2.5806e-03, 9.2656e-03, -1.6489e-02, -1.1252e-02,
                                2.6684e-02, 2.2736e-03, -2.3382e-03, 3.1900e-02, 3.9795e-04,
                                -9.5909e-04, -1.2864e-02, 1.3218e-03, 2.2584e-03, -9.3707e-03,
                                -3.9963e-03, 8.8583e-03, -1.9449e-03, -7.1170e-03, -9.1485e-03,
                                4.5724e-03, -4.6279e-03, -1.8506e-02, 4.3894e-03, -3.8075e-03,
                                -1.0739e-02, -4.1646e-04, -4.8419e-03, -5.7098e-03, 2.9081e-03,
                                -2.6468e-03, -1.3337e-02, -5.4628e-03, 6.2865e-03, -1.1805e-02,
                                1.0347e-03, -8.0582e-03, -1.4679e-03, -2.4281e-02, -5.1362e-04,
                                -6.3389e-03, 8.2377e-04, 1.0391e-03, 2.2610e-03, -1.9169e-02,
                                7.8600e-03, -1.6408e-03, -1.8467e-02, 4.0536e-03, 9.1158e-03,
                                8.1177e-04, 1.2418e-03, 5.9174e-03, 3.6518e-03, -7.1975e-03,
                                -1.3537e-02, -7.1715e-03, -7.8475e-04, -1.6762e-02, -1.5890e-02,
                                -1.6095e-03, -9.9735e-03, -2.6222e-03, 3.4293e-02, 3.8864e-03,
                                -8.1195e-04, -9.8710e-03, 8.2673e-03, -7.5392e-03, -4.8212e-03,
                                -8.5562e-03, 5.9110e-04, -7.3447e-03, 3.7157e-03, -1.2768e-02,
                                -8.4343e-03, -9.5008e-03, 7.5783e-04, -7.8986e-03, 8.8008e-04,
                                -2.7436e-03, 6.9698e-03, -3.2570e-03, 1.2784e-03, -2.3702e-03,
                                -2.3570e-03, 2.2773e-04, -7.7139e-03, 1.4778e-03, 1.1341e-02,
                                -5.0125e-03, -6.8869e-04, -8.1811e-03, 1.7377e-02, -5.3072e-03,
                                -7.3456e-03, 4.2082e-01],
                               [-4.7436e-05, 2.3617e-02, 4.9685e-02, 9.1502e-02, 1.6141e-02,
                                -4.7282e-02, 1.2550e-02, 1.5741e-02, 3.1111e-02, 1.7963e-02,
                                1.1787e-02, 7.2866e-02, -1.6454e-02, 2.4705e-04, 6.5348e-02,
                                -1.4824e-03, 1.0759e-02, 4.8809e-02, -6.0394e-03, 4.0840e-02,
                                1.1261e-03, 2.4482e-02, 4.8416e-02, 2.1446e-02, 2.2248e-02,
                                2.6317e-02, 7.2008e-02, 7.1500e-03, 5.5661e-02, 1.0481e-02,
                                4.3042e-02, 2.5098e-02, 1.3427e-02, -1.2483e-02, 4.1348e-02,
                                4.1013e-03, 2.4592e-02, 3.8412e-02, 3.8458e-02, 5.0589e-02,
                                1.2487e-02, 1.9746e-02, 2.9212e-02, 4.2996e-02, -1.4884e-03,
                                2.5849e-02, 2.9030e-02, 2.5764e-02, 2.7834e-02, 1.1865e-02,
                                5.0696e-02, 4.2566e-03, 4.9896e-02, 1.9355e-02, 7.6337e-04,
                                2.3921e-02, 3.2668e-02, 3.4700e-02, 8.2100e-03, 3.7521e-02,
                                4.0200e-02, 1.0046e-04, 9.4712e-03, 2.7439e-02, 1.8638e-02,
                                -7.2808e-03, -9.3506e-02, 5.8567e-04, -2.7815e-03, 4.2736e-02,
                                2.7413e-02, -3.5877e-02, 2.6959e-02, 4.7079e-01, 8.6612e-03,
                                -1.8301e-02, 2.6043e-02, 4.5711e-02, 2.3672e-02, -4.0955e-02,
                                2.1670e-02, 1.4876e-02, 1.5278e-02, 3.5099e-03, -1.3135e-02,
                                2.8896e-02, -2.6596e-03, 2.1950e-02, 6.5145e-03, 1.7656e-02,
                                -3.2946e-02, -4.2673e-03, 6.4089e-03, -1.7257e-02, -2.3343e-02,
                                3.3714e-02, 1.6188e-03, 2.2402e-02, 4.3144e-02, -9.3527e-03,
                                -5.0868e-03, 1.4358e-02, -5.3177e-03, 4.1592e-01, -1.6379e-02,
                                -4.4615e-03, 3.1536e-02, 2.1151e-02, 3.0535e-02, 3.7486e-02,
                                -1.1685e-02, 1.8808e-01, 4.9448e-02, 6.5694e-03, 1.2016e-02,
                                1.3356e-02, 2.7200e-02, 4.4622e-03, -9.8881e-03, 2.7810e-02,
                                1.6335e-03, 2.5756e-02, 1.0559e-02, 1.0114e-02, -5.0744e-03,
                                1.0627e-02, 2.6080e-02, 3.0503e-02, 2.6865e-02, 9.1590e-03,
                                3.3245e-02, 2.0863e-02, 2.6022e-02, 8.1066e-02, 2.0333e-04,
                                3.2201e-02, 2.6372e-02, 1.3098e-02, 8.4110e-03, 7.7517e-03,
                                1.4608e-02, 1.4786e-02, 7.9259e-02, 1.5554e-02, -1.7712e-02,
                                2.6677e-02, 1.1205e-02, 2.0257e-02, -1.4117e-02, 3.6240e-02,
                                5.3785e-02, 5.7992e-03, 9.4652e-03, 6.6086e-02, 2.5205e-02,
                                1.3351e-02, 7.2153e-03, 9.6135e-03, -4.4637e-02, 1.4855e-02,
                                2.1928e-02, 4.8130e-02, -5.0659e-04, 2.1766e-02, 2.7506e-02,
                                4.0283e-02, 2.0244e-02, 1.8317e-02, 1.5249e-02, -2.4861e-03,
                                3.6135e-02, 1.1491e-02, 2.0609e-02, 3.8682e-02, -2.4441e-03,
                                -1.5947e-02, 3.7819e-02, 3.2292e-02, 2.8340e-02, 5.2008e-02,
                                -1.1557e-02, 5.4343e-03, 2.4694e-02, 2.4175e-02, 3.5147e-02,
                                8.4488e-03, 2.0858e-02, 2.2920e-02, 2.2671e-03, 4.9380e-02,
                                5.6014e-02, -5.9526e-01],
                               [-8.3260e-03, -1.3304e-02, -5.5541e-02, -1.0546e-01, -2.1160e-02,
                                2.6503e-01, -1.0075e-02, -2.4030e-02, -3.0867e-02, -3.2315e-02,
                                -1.4663e-02, -1.0078e-01, 8.7643e-03, 3.6444e-03, -7.5013e-02,
                                -5.8938e-03, -1.2089e-02, -5.8057e-02, -7.0768e-03, -3.4527e-02,
                                -4.9010e-03, -2.4288e-02, -4.0123e-02, -1.7903e-02, -8.8741e-03,
                                -2.0035e-02, -4.4590e-02, -1.0324e-02, -3.4811e-02, 2.3362e-02,
                                -4.4946e-02, -9.7498e-04, -4.1014e-02, 2.6242e-02, -4.3296e-02,
                                -6.2937e-03, -1.5962e-02, -2.9545e-02, -2.4599e-02, -1.2874e-02,
                                1.7562e-03, -2.3315e-02, -2.6298e-02, -2.2632e-02, 9.9750e-03,
                                -6.0496e-03, -7.2201e-03, -2.9532e-02, -1.9483e-02, -3.4702e-03,
                                -5.1301e-02, -4.0628e-03, -3.3051e-02, -1.7515e-02, -1.2447e-02,
                                -2.4449e-02, -3.3412e-02, -3.2885e-02, 3.8310e-03, -3.4956e-02,
                                -7.5270e-03, -9.5428e-03, -2.5761e-02, -2.2875e-02, -9.1033e-03,
                                -1.0442e-02, 8.9669e-02, -1.2591e-02, -6.0224e-03, -3.9254e-02,
                                -1.4423e-02, 2.2784e-02, -2.5467e-02, -5.0557e-01, -1.5614e-02,
                                1.5184e-02, -3.3582e-02, -4.5360e-02, -2.7877e-02, 2.8602e-02,
                                -3.3642e-04, -1.3550e-02, -1.2545e-03, -3.4507e-03, 9.6067e-03,
                                -3.2404e-02, 2.5868e-03, -2.1022e-02, 8.5383e-03, -3.1988e-02,
                                1.6182e-02, 1.7882e-02, 1.0719e-02, 2.3527e-02, 4.1260e-02,
                                -3.9355e-02, 1.2067e-02, -2.4503e-02, -5.3267e-02, -1.1066e-02,
                                4.8308e-04, -1.2391e-02, -4.8997e-03, -4.5433e-01, -1.7955e-03,
                                2.9720e-03, -9.4546e-03, -1.6070e-02, -2.8657e-02, -3.1052e-02,
                                1.5112e-03, -1.7094e-01, -4.5381e-02, -9.8535e-03, 1.2845e-02,
                                -2.0731e-02, -2.6322e-02, -5.3873e-03, 6.6962e-03, -4.2189e-02,
                                -6.7612e-03, -2.0917e-02, -2.5483e-02, -1.3623e-02, -3.9094e-03,
                                -1.9837e-02, -1.9123e-02, -2.3297e-02, -3.1696e-02, 1.6067e-02,
                                -1.8796e-02, -6.3934e-03, -2.5659e-02, -8.3135e-02, 2.7905e-03,
                                -1.4403e-02, -3.9122e-02, -1.4342e-02, -2.2479e-02, 6.5473e-03,
                                -1.4578e-02, -1.6336e-02, -8.9952e-02, -2.4443e-02, 5.9017e-03,
                                9.8947e-04, -1.0297e-02, -4.7634e-03, 8.6613e-03, -2.1058e-02,
                                -4.3835e-02, -4.8786e-03, -1.6968e-02, -4.2839e-02, -2.1200e-02,
                                -3.6796e-03, -7.2422e-03, -1.8559e-03, 6.3171e-02, -3.2215e-02,
                                -2.6044e-02, -4.9810e-02, 6.4040e-03, 2.5755e-03, -2.1681e-02,
                                -1.8692e-02, -1.8521e-02, -3.0694e-02, -1.5711e-02, -1.1973e-02,
                                -1.8172e-02, -1.9749e-02, -1.8459e-02, -3.6572e-02, 1.8666e-03,
                                3.1192e-02, -2.7374e-02, -2.7895e-02, -3.8055e-02, -8.0461e-03,
                                3.2789e-03, 2.6252e-03, -8.9855e-03, -3.4822e-03, -3.2178e-02,
                                -1.8592e-02, -1.7732e-02, -2.7557e-02, 1.3140e-02, -6.5093e-02,
                                -4.5254e-02, -8.8559e-02],
                               [4.0953e-02, 1.5432e-02, 2.5741e-02, -6.9558e-02, 2.3728e-02,
                                2.4579e-01, 1.4164e-02, 1.9014e-02, 2.9759e-02, 2.7344e-02,
                                2.7795e-02, -2.5311e-02, 2.7132e-02, 2.3737e-02, -4.2793e-02,
                                -2.9249e-03, -3.5917e-03, -1.1038e-03, -8.8822e-03, 3.0456e-02,
                                8.4940e-03, 1.1655e-02, 2.8936e-02, 2.8470e-02, 2.7022e-02,
                                2.2023e-02, 6.8019e-02, 4.1942e-02, 2.6701e-02, 2.9110e-02,
                                2.8259e-02, 1.1321e-02, 4.0667e-02, 3.5698e-02, -2.4495e-02,
                                5.9156e-02, 4.8492e-02, 5.7999e-02, 3.7324e-02, -2.1859e-02,
                                1.7088e-02, 4.0470e-02, 2.6943e-02, 2.1726e-02, 3.1161e-02,
                                6.2481e-02, 1.3849e-02, 4.8720e-02, 3.9207e-02, 6.1383e-03,
                                -6.8603e-02, 1.7732e-02, 4.1947e-02, 4.6155e-02, 2.5852e-02,
                                5.3379e-03, 5.4945e-02, 2.7429e-02, 5.1932e-02, 1.8140e-03,
                                2.7019e-02, 3.6331e-02, 1.6152e-02, 4.9936e-02, 2.6051e-02,
                                3.1074e-02, 4.8719e-02, 1.3750e-02, 4.0902e-02, -9.6537e-03,
                                4.8503e-02, 2.6989e-02, 2.5895e-02, -3.8171e-01, 4.6335e-02,
                                2.6677e-02, -3.1537e-03, 3.5457e-02, 2.0403e-02, 2.6795e-03,
                                5.6244e-03, 2.4334e-03, 4.8871e-02, 3.6754e-02, 3.5411e-02,
                                3.1270e-02, 4.0911e-02, -2.3733e-03, 4.6023e-02, 5.0420e-02,
                                4.4842e-02, 2.0999e-02, 1.4680e-02, 5.0957e-03, 2.9923e-02,
                                1.2521e-02, 3.3257e-02, 5.7500e-02, 9.7630e-05, 1.3790e-02,
                                6.0632e-02, 2.7407e-02, 2.0690e-02, -1.2516e-01, -2.4231e-02,
                                3.1498e-02, -2.8196e-02, 3.8801e-02, 2.4982e-02, 2.2396e-02,
                                2.9590e-02, 3.9952e-01, 2.4502e-02, 2.2285e-02, 2.0694e-02,
                                2.8905e-02, 4.4038e-02, -1.2158e-02, 1.7733e-02, 2.3340e-02,
                                2.6666e-02, 9.8045e-03, 3.7379e-02, 6.9301e-02, 2.7156e-02,
                                5.2949e-02, 1.0841e-02, 3.6457e-03, 6.3758e-02, 3.6007e-02,
                                4.3155e-02, 2.9662e-02, 3.6897e-02, -2.4387e-02, 2.3290e-02,
                                3.8056e-02, -8.1247e-04, 2.4775e-02, 1.1201e-02, 2.0911e-02,
                                3.8733e-02, 1.0973e-02, -1.9566e-02, 2.5529e-02, 3.8308e-02,
                                2.4631e-02, 2.1102e-02, 4.2480e-02, 2.0680e-02, 3.8975e-02,
                                1.5167e-02, 3.0877e-02, 4.1855e-02, 1.5506e-02, 1.4404e-02,
                                3.3035e-02, 2.1881e-02, 5.0022e-02, 9.1835e-02, 3.3724e-02,
                                2.8731e-02, -2.3004e-02, 2.5452e-02, 5.0192e-02, 2.8971e-02,
                                6.2790e-02, -3.8895e-03, 3.0138e-02, 3.6261e-02, 1.5897e-02,
                                1.1854e-02, -1.4541e-03, 2.6162e-02, 2.2005e-03, 2.6596e-02,
                                1.2401e-02, 1.7139e-02, 5.1281e-02, 3.3957e-02, 2.8849e-02,
                                2.3764e-02, 2.6202e-02, 5.4989e-02, 3.8517e-02, 3.3086e-02,
                                1.6645e-04, 6.5849e-03, -8.6543e-03, 4.4400e-02, -1.7492e-03,
                                1.7796e-04, 1.8379e-01],
                               [1.5173e-02, -2.3313e-03, 4.8073e-03, -4.2887e-02, 1.4935e-02,
                                2.3444e-01, 5.0670e-02, 1.1866e-02, 2.6682e-02, -7.0692e-03,
                                3.0437e-02, -4.5910e-02, 2.0422e-02, 1.9315e-02, -3.7089e-02,
                                1.4102e-02, 3.4594e-02, 1.5745e-02, 4.3773e-02, 1.5865e-02,
                                2.3702e-02, 3.8206e-02, -9.4792e-03, 2.1265e-02, 2.9652e-02,
                                2.0746e-02, 2.2991e-02, 2.4397e-02, 8.6199e-03, 1.8298e-02,
                                9.8175e-03, 4.7608e-02, -1.4606e-03, 4.7642e-02, -8.3665e-03,
                                -2.1546e-03, 2.5622e-03, -1.3996e-02, 3.9356e-02, -7.2750e-04,
                                2.0747e-03, -1.6841e-02, 2.2653e-02, 2.9733e-02, 2.6586e-02,
                                2.1259e-02, 5.2581e-02, -2.1084e-03, 2.4450e-02, 2.7496e-02,
                                -1.6419e-03, 2.3133e-02, 1.0602e-02, 1.0389e-02, 1.1725e-02,
                                3.8593e-02, 4.8082e-03, 9.9058e-03, -1.2246e-02, -6.0305e-03,
                                2.4668e-02, 1.5695e-02, 2.5603e-02, 1.4172e-02, 1.7910e-02,
                                1.0607e-02, -7.8204e-03, 4.3353e-02, 1.6309e-02, -3.6121e-02,
                                1.6528e-02, 2.3107e-02, -1.1616e-02, 1.3560e-01, 1.9172e-02,
                                1.2913e-02, 3.7164e-02, 3.4064e-02, 3.1014e-02, 4.9511e-02,
                                2.4008e-02, 4.2325e-02, 1.3996e-02, -5.0718e-03, -7.7833e-03,
                                2.6916e-02, 3.7979e-02, 2.5773e-02, 2.7332e-02, 1.1808e-02,
                                -6.1698e-03, 2.1972e-02, 3.7216e-03, 2.9750e-02, -1.1523e-04,
                                9.8719e-03, 3.2356e-02, -7.5358e-03, -4.2311e-03, 1.7711e-02,
                                2.4332e-02, 2.4937e-02, 1.6767e-02, 3.9243e-02, 6.3097e-02,
                                -1.1061e-02, 5.0472e-02, 1.2383e-02, 2.9106e-02, 3.6092e-02,
                                1.7172e-02, -4.3203e-01, 2.2506e-02, 1.5905e-02, 3.8026e-02,
                                2.3344e-02, 2.1296e-02, 7.7205e-03, 3.4843e-02, -2.4903e-02,
                                1.1365e-04, 2.2699e-02, 5.5221e-04, -1.6592e-02, 7.2749e-03,
                                5.3016e-03, 1.7118e-02, 1.2952e-02, -6.8958e-03, 4.1842e-03,
                                9.0929e-03, 9.9698e-03, 1.2202e-02, 1.1594e-02, 1.6199e-02,
                                7.7965e-03, 2.6862e-02, 1.9019e-02, 1.3889e-02, 1.2307e-02,
                                1.6949e-02, 8.7789e-03, -2.7247e-02, 5.1976e-03, 3.9854e-02,
                                2.4295e-02, 2.9278e-02, -1.9076e-03, 2.2203e-02, -1.8209e-02,
                                1.3196e-02, 2.4128e-02, 2.9897e-02, 9.9460e-04, 6.6931e-03,
                                2.2103e-02, 4.0790e-02, -5.6597e-03, 3.2845e-02, -1.1801e-03,
                                3.0276e-04, 1.1832e-02, 2.1189e-02, -2.2022e-02, 1.1123e-02,
                                -1.1091e-02, 3.1229e-02, -6.6435e-03, 8.9228e-03, 3.1455e-02,
                                5.9361e-04, 3.9409e-02, 2.4343e-02, 2.4089e-02, 3.1383e-02,
                                2.4434e-02, 1.5496e-02, -8.2319e-03, 1.0502e-02, 2.3854e-02,
                                2.3640e-02, 5.3816e-03, 7.1941e-03, 1.9961e-02, 2.9965e-02,
                                3.7015e-02, 1.7981e-02, 5.2460e-02, 6.8132e-03, 1.8621e-02,
                                2.8663e-02, 3.3716e-01],
                               [-5.6987e-02, -2.0062e-02, -5.1455e-02, 5.1249e-02, -5.0529e-02,
                                -8.5858e-02, -4.5464e-02, -3.9032e-02, -7.0718e-02, -5.9038e-02,
                                -4.7714e-02, 1.8603e-02, -5.5649e-02, -5.9282e-02, 1.6732e-02,
                                -4.0834e-02, -3.0501e-02, -1.7785e-02, -4.0839e-02, -3.5983e-02,
                                -2.2996e-02, -3.5358e-02, -3.2616e-02, -5.1477e-02, -5.1802e-02,
                                -2.6682e-02, -7.4662e-02, -6.1296e-02, -1.0752e-02, -3.9774e-02,
                                -4.4774e-02, -2.9903e-02, -6.0422e-02, -7.2664e-02, 1.0527e-02,
                                -5.6283e-02, -1.9189e-02, -1.8434e-02, -5.7688e-02, 4.3434e-02,
                                -1.8943e-02, -3.9359e-02, -4.2912e-02, -4.6514e-02, -6.8496e-02,
                                -4.3876e-02, -4.2317e-02, -5.2745e-02, -5.8379e-02, -3.7869e-02,
                                5.7820e-02, -5.4646e-02, -5.8036e-02, -5.5128e-02, -4.3458e-02,
                                -4.8091e-02, -5.7660e-02, -2.3787e-02, -3.6017e-02, -7.9811e-03,
                                -2.4464e-02, -6.1724e-02, -3.9154e-02, -5.4245e-02, -4.4125e-02,
                                -3.6223e-02, -5.0714e-02, -7.5242e-02, -6.5753e-02, 1.4947e-02,
                                -5.9792e-02, -5.1272e-02, -1.6012e-02, 2.3255e-01, -7.6721e-02,
                                -4.3059e-02, -5.9704e-02, -6.3645e-02, -5.5186e-02, -6.4114e-02,
                                -2.9923e-02, -5.1170e-02, -5.0470e-02, -4.0733e-02, -3.9520e-02,
                                -5.6829e-02, -5.5892e-02, -3.2972e-02, -7.2983e-02, -5.4010e-02,
                                -4.1676e-02, -3.2382e-02, -1.8433e-02, -4.9292e-02, 2.0794e-03,
                                -2.2953e-02, -5.3516e-02, -5.4333e-02, -1.1078e-02, -6.2937e-02,
                                -7.1464e-02, -4.3947e-02, -3.8071e-02, 7.8175e-02, -5.5998e-02,
                                -2.8432e-02, -1.6872e-02, -4.9818e-02, -5.9371e-02, -5.1430e-02,
                                -6.6767e-02, 6.7435e-02, -4.0891e-02, -4.5768e-02, -3.8228e-02,
                                -5.0883e-02, -5.6641e-02, -2.1901e-02, -4.5753e-02, -4.4664e-03,
                                -3.4883e-02, -3.7203e-02, -5.3641e-02, -4.5940e-02, -2.8371e-02,
                                -6.9880e-02, -3.9215e-02, -1.2740e-02, -4.9735e-02, -3.6451e-02,
                                -4.9929e-02, -4.0945e-02, -3.9024e-02, -7.4323e-03, -6.0438e-02,
                                -4.3707e-02, -4.2676e-02, -2.7006e-02, -4.7102e-02, -5.0488e-02,
                                -3.6160e-02, -4.4305e-02, 1.5345e-02, -3.6137e-02, -9.2557e-02,
                                -2.4479e-02, -4.7549e-02, -3.9232e-02, -5.5624e-02, -2.8146e-03,
                                -2.3607e-02, -5.8906e-02, -7.2380e-02, -2.4056e-02, -2.0750e-02,
                                -4.4487e-02, -6.7649e-02, -4.1840e-02, -6.5349e-02, -5.2649e-02,
                                -4.6073e-02, -2.6515e-03, -3.0618e-02, -3.0253e-03, -3.4845e-02,
                                -3.3528e-02, -1.8836e-02, -3.5596e-02, -2.1125e-02, -6.2765e-02,
                                -1.0663e-02, -3.1939e-02, -4.3677e-02, -5.4967e-02, -5.9377e-02,
                                -3.4299e-02, -3.0579e-02, -5.0983e-02, -4.2970e-02, -4.3669e-02,
                                -6.5356e-02, -3.5166e-02, -6.5713e-02, -5.6761e-02, -5.5365e-02,
                                -4.5677e-02, -2.3250e-02, -4.0910e-02, -1.5827e-02, -2.7849e-02,
                                -6.0736e-03, -7.5022e-01]]])

        z = token
        for i in range(b - 1):
            z = torch.cat((z, token), dim=0)

        x = self.bneck(self.stem(x))
        for m in self.block:
            x, z = m(x, z)

        # 转成b个平铺一维向量
        x = self.avg(self.bn(self.conv(x))).view(b, -1)
        # 取第一个token
        z = z[:, 0, :].view(b, -1)
        # 最后一个维度拼接
        out = torch.cat((x, z), -1)

        out = self.head1(out)
        out = self.tanh(out)
        out = self.head2(out)
        return out
