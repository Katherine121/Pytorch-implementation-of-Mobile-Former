import torch
import torch.nn as nn

from torch.nn import init
import torch.nn.functional as F

from mobile_former.mobile import Mobile, MobileDown
from mobile_former.former import Former
from mobile_former.bridge import Former2Mobile


class hswish(nn.Module):
    def forward(self, x):
        out = x * F.relu6(torch.add(x, 3.0)) / 6.0
        return out


class BaseBlock(nn.Module):
    def __init__(self, inp, exp, out, se, stride, heads, dim):
        super(BaseBlock, self).__init__()
        if stride == 2:
            self.mobile = MobileDown(3, inp, exp, out, stride)
        else:
            self.mobile = Mobile(3, inp, exp, out, stride)
        self.former = Former(dim=dim)
        self.former2mobile = Former2Mobile(dim=dim, heads=heads, channel=out)

    def forward(self, x, z):
        z_out = self.former(z)
        x_hid = self.mobile(x)
        x_out = self.former2mobile(x_hid, z_out)
        return x_out, z_out


class MobileFormer(nn.Module):
    def __init__(self, cfg):
        super(MobileFormer, self).__init__()
        # 初始化6*192token
        self.token = nn.Parameter(nn.Parameter(torch.randn(1, cfg['token'], cfg['embed'])))

        # stem 3 224 224 -> 16 112 112
        self.stem = nn.Sequential(
            nn.Conv2d(3, cfg['stem'], kernel_size=3, stride=2, padding=1, bias=False),
            nn.BatchNorm2d(cfg['stem']),
            hswish()
        )
        # bneck 先*2后还原，步长为1，组卷积
        self.bneck = nn.Sequential(
            nn.Conv2d(cfg['stem'], cfg['bneck']['e'], kernel_size=3, stride=cfg['bneck']['s'], padding=1,
                      groups=cfg['stem']),
            hswish(),
            nn.Conv2d(cfg['bneck']['e'], cfg['bneck']['o'], kernel_size=1, stride=1),
            nn.BatchNorm2d(cfg['bneck']['o'])
        )

        # body
        self.block = nn.ModuleList()
        for kwargs in cfg['body']:
            # 把{'inp': 12, 'exp': 72, 'out': 16, 'stride': 2, 'heads': 2}和token维度192传进去
            self.block.append(BaseBlock(**kwargs, dim=cfg['embed']))

        inp = cfg['body'][-1]['out']
        exp = cfg['body'][-1]['exp']
        self.conv = nn.Conv2d(inp, exp, kernel_size=1, stride=1, padding=0, bias=False)
        self.bn = nn.BatchNorm2d(exp)
        self.avg = nn.AvgPool2d((7, 7))

        self.head1 = nn.Linear(exp + cfg['embed'], cfg['fc1'])
        self.tanh = hswish()
        self.head2 = nn.Linear(cfg['fc1'], cfg['fc2'])

        self.init_params()

    def init_params(self):
        for m in self.modules():
            if isinstance(m, nn.Conv2d):
                init.kaiming_normal_(m.weight, mode='fan_out')
                if m.bias is not None:
                    init.constant_(m.bias, 0)
            elif isinstance(m, nn.BatchNorm2d):
                init.constant_(m.weight, 1)
                init.constant_(m.bias, 0)
            elif isinstance(m, nn.Linear):
                init.normal_(m.weight, std=0.001)
                if m.bias is not None:
                    init.constant_(m.bias, 0)

    def forward(self, x):
        # batch_size
        b = x.shape[0]
        # 因为最开始初始化的是1*6*192，在0维度重复b次，1维度重复1次，2维度重复1次，就形成了b*6*192
        # z = self.token.repeat(b, 1, 1)
        token = torch.Tensor([[[-1.3738e-02, 1.9405e-03, -3.7699e-03, -1.6903e-02, 3.5069e-03,
                                1.5616e-01, -1.0630e-03, 3.7402e-03, 4.0500e-03, 6.9936e-03,
                                -3.0347e-03, -6.7455e-02, 2.9130e-03, -2.0118e-02, -4.7212e-02,
                                1.9632e-03, -2.7525e-03, 1.3698e-03, -5.4782e-03, 4.3467e-03,
                                -2.5579e-03, -6.1660e-03, 3.1481e-03, 8.2316e-03, 4.3911e-03,
                                -2.2417e-03, -4.7515e-03, -2.0904e-03, -7.2651e-03, -1.2504e-02,
                                -2.6821e-03, 2.7385e-03, -1.0626e-02, -4.8661e-03, -8.8099e-03,
                                -2.5960e-03, 1.3725e-03, -7.6435e-04, -2.9401e-03, -3.9364e-03,
                                2.1000e-03, -8.2619e-03, -3.1625e-03, -6.6312e-04, -6.7431e-03,
                                3.6869e-03, -9.1125e-03, 7.9320e-03, -5.3634e-03, -2.4728e-03,
                                -7.7753e-03, 1.0443e-02, 4.2786e-03, 1.1662e-02, 4.1115e-03,
                                4.9443e-03, 2.0663e-04, -3.1114e-03, 6.8265e-03, -4.3181e-03,
                                -2.2869e-03, -1.5446e-03, 1.0076e-02, -7.4116e-03, -2.0371e-03,
                                -1.1397e-02, 7.6172e-04, 7.1153e-04, -3.0272e-03, -4.1049e-02,
                                -8.4570e-03, -8.3584e-03, -1.2029e-03, 2.4447e-02, 9.4843e-03,
                                -9.8958e-03, 3.2031e-03, 6.8145e-03, -5.9890e-03, -1.2662e-02,
                                5.1388e-03, -3.2780e-03, -1.2147e-02, -4.7207e-03, -1.4385e-02,
                                -1.1931e-02, -4.4022e-03, 4.1103e-03, 3.1491e-04, 1.0319e-03,
                                -2.0940e-03, -9.2935e-03, -1.2664e-03, 3.0371e-03, 4.5937e-03,
                                3.9026e-03, 6.0669e-04, 5.3819e-04, -2.2363e-02, -4.1717e-03,
                                -3.4958e-03, 1.6342e-03, 4.2908e-04, 1.0974e-02, -7.4640e-03,
                                -8.6482e-03, -1.7264e-03, 5.5699e-04, 7.2488e-03, 3.9685e-03,
                                -2.4041e-03, -3.8083e-03, 2.4108e-03, 1.2538e-04, -2.8725e-03,
                                5.1035e-03, -2.4073e-03, -4.5460e-03, 3.3110e-03, -6.0231e-03,
                                -3.0388e-03, -5.2692e-03, -1.9778e-03, -7.7971e-05, 3.7507e-03,
                                1.6991e-03, 2.4519e-04, -3.2314e-04, 1.4175e-03, -2.7770e-03,
                                -8.9615e-05, -1.9130e-02, -7.6078e-03, -2.4341e-02, -3.3920e-03,
                                6.2868e-03, 2.5364e-03, -1.4105e-02, -2.8490e-03, 5.4854e-06,
                                -1.5404e-03, -5.5183e-05, -1.0173e-02, -1.0126e-02, -1.5085e-03,
                                3.8695e-03, -5.2478e-03, -3.7967e-03, 9.7941e-03, 1.3319e-03,
                                -8.8489e-03, -4.2506e-03, -3.5809e-03, -1.0782e-02, -2.0856e-03,
                                2.6020e-03, 2.3160e-03, -1.1760e-03, 1.5205e-02, 1.2711e-03,
                                4.0472e-03, -9.2300e-03, -3.5356e-03, -5.5853e-03, -3.1868e-03,
                                -9.7382e-03, 1.4004e-03, -5.4560e-03, 8.1978e-03, 8.3163e-03,
                                2.3790e-03, -5.0668e-03, -1.1107e-02, -9.4183e-03, 3.1300e-03,
                                -4.4028e-03, -8.3486e-03, -7.7043e-03, -1.7530e-02, 5.4457e-03,
                                -2.1114e-03, -4.4341e-03, -1.3185e-03, -2.3051e-03, 4.3821e-03,
                                5.2627e-03, -3.0255e-03, -2.0090e-03, 3.7910e-03, -5.8431e-03,
                                -9.7439e-03, 2.9037e-01],
                               [2.8958e-02, 4.6136e-02, 3.6778e-02, 7.1113e-02, 2.8458e-02,
                                -6.2099e-02, 1.7855e-02, 4.8362e-02, 1.1487e-02, 1.2135e-02,
                                2.7890e-02, 4.0687e-02, -3.2435e-03, 3.5591e-03, 4.8595e-02,
                                3.1684e-02, 8.0194e-03, 3.3913e-02, 1.6628e-02, 3.9202e-02,
                                1.3322e-02, 3.9057e-02, 3.1125e-02, 1.1858e-02, 9.9252e-03,
                                1.5171e-02, 2.7670e-02, 3.1926e-02, 9.7652e-03, 3.0386e-03,
                                2.8025e-02, 2.6319e-02, 4.8388e-02, 1.2055e-02, 4.0467e-02,
                                3.1973e-02, 3.1805e-03, 2.2828e-02, 3.1103e-02, 1.1624e-02,
                                1.8374e-02, 2.8465e-02, 1.1661e-03, 4.3874e-02, 2.8453e-02,
                                4.5039e-02, 2.5158e-02, 3.8760e-02, 4.1536e-02, 3.2527e-02,
                                2.7655e-02, 4.0634e-03, 1.7141e-02, 3.0344e-02, 3.3688e-02,
                                3.0960e-02, 2.4578e-02, 2.9431e-02, 4.3257e-02, 3.1277e-02,
                                4.4850e-02, 2.1116e-02, 2.3183e-02, 1.9753e-02, 2.1489e-02,
                                2.4611e-02, -7.2809e-03, 2.2496e-02, 2.7493e-02, 6.1619e-02,
                                4.0330e-02, 3.6628e-02, 3.0218e-02, 3.8875e-01, 3.4732e-02,
                                1.6009e-02, 3.9230e-04, 2.7771e-02, 2.8930e-02, 6.3882e-04,
                                4.5283e-02, 1.6428e-02, 9.5441e-03, 1.7516e-02, 6.8285e-03,
                                2.7851e-02, 1.9986e-02, 4.2990e-02, 1.9036e-02, -6.1407e-03,
                                1.9759e-02, 1.9209e-02, 5.9529e-03, -3.9235e-03, 1.5778e-02,
                                3.0611e-02, 3.6989e-02, 7.0710e-03, 5.3799e-02, 2.8854e-02,
                                3.0576e-02, 3.5344e-02, 2.2272e-02, 3.0119e-01, 3.2381e-02,
                                3.0082e-02, 4.4321e-02, 3.2356e-02, 2.2261e-02, 3.2304e-02,
                                1.1117e-03, 1.1216e-01, 3.6931e-02, 4.6512e-02, 2.6401e-02,
                                3.8688e-02, 4.8403e-02, 3.4439e-02, 2.5172e-04, 3.2348e-02,
                                1.4328e-02, 1.9111e-02, 1.6807e-02, 3.6649e-02, 2.5448e-02,
                                2.3248e-02, 2.2530e-02, 4.1910e-02, 5.3394e-02, 2.0182e-02,
                                3.4656e-02, -1.3625e-03, 1.7798e-02, 5.3778e-02, -1.9361e-03,
                                1.7711e-02, 2.6651e-02, 1.8672e-03, 2.1015e-02, 2.6218e-02,
                                3.1435e-02, 2.6620e-02, 5.1453e-02, 2.6911e-02, 1.2364e-02,
                                3.2399e-02, 2.3256e-02, 1.4104e-02, 4.6805e-03, 3.2542e-02,
                                3.3773e-02, 1.0690e-02, 1.6295e-02, 3.8466e-02, 3.6519e-02,
                                1.4455e-02, 7.1980e-03, 1.7813e-02, -1.3667e-02, 1.2385e-02,
                                4.4557e-02, 5.0990e-02, 1.1826e-02, 2.0407e-02, 3.7273e-02,
                                3.0603e-02, 3.7665e-02, 5.8132e-02, -2.8643e-03, 1.7555e-02,
                                3.7093e-02, 2.1653e-02, 2.3842e-02, 2.5709e-02, 3.9238e-02,
                                -4.9564e-03, 1.4844e-02, 1.3804e-02, 1.7345e-02, 1.2046e-02,
                                4.1668e-02, 1.5842e-02, 3.4634e-02, 3.9799e-02, 3.8942e-02,
                                7.0215e-03, 3.0266e-02, 2.6949e-02, 1.8574e-02, 2.7732e-02,
                                3.2034e-02, -6.2690e-01],
                               [-2.7350e-02, -4.5524e-02, -2.0359e-02, -6.9073e-02, -2.7038e-02,
                                2.7621e-01, -2.0469e-02, -2.0848e-02, -2.7608e-02, 2.2368e-03,
                                -7.1654e-03, -7.8594e-02, -8.3249e-03, 2.0986e-03, -9.0452e-02,
                                -3.0087e-02, -1.5327e-02, -4.2964e-02, 1.1697e-03, -3.1320e-02,
                                -3.3762e-03, -3.4396e-02, -2.4043e-02, -1.1948e-02, 1.4682e-03,
                                -1.9474e-02, -1.6390e-02, -8.8239e-03, -2.4854e-02, -3.7444e-03,
                                -2.9242e-02, -3.8748e-02, -6.0186e-02, 5.1569e-03, -4.1276e-02,
                                -2.1622e-02, -2.2585e-02, -4.8022e-03, -3.0840e-02, -1.6458e-02,
                                -1.8286e-02, -3.1691e-02, -1.5292e-02, -2.4421e-02, -2.3425e-02,
                                -3.7196e-02, -1.6157e-02, -1.6134e-02, -3.0286e-02, -1.4130e-02,
                                -2.3076e-02, -1.0742e-02, -1.5422e-02, -2.3290e-02, -2.2884e-02,
                                -3.1229e-02, -1.5761e-02, -9.1285e-03, -1.6105e-02, -3.8712e-02,
                                -3.2906e-02, -3.7670e-02, -1.6260e-02, -1.2156e-02, -1.4469e-02,
                                -2.1976e-02, 1.1553e-02, -3.8679e-02, -1.8786e-02, -1.0093e-01,
                                -2.8132e-02, -2.8318e-02, -1.8993e-02, -4.2350e-01, -2.7178e-02,
                                -1.5822e-02, -1.5530e-02, -1.4590e-02, -2.9263e-02, -7.2716e-03,
                                -3.1814e-02, -1.6412e-02, -3.1893e-03, -2.2871e-02, -7.7122e-03,
                                -5.6418e-03, -1.2473e-02, -3.2800e-02, -1.7697e-02, -9.8522e-03,
                                -2.1129e-02, -1.3093e-02, -1.4988e-02, -1.2525e-02, -2.2828e-02,
                                -2.2675e-02, -2.3348e-02, -1.4784e-02, -4.6968e-02, -2.5409e-02,
                                -3.6252e-02, -2.8238e-02, -1.7093e-02, -3.1038e-01, -1.0236e-02,
                                -1.7702e-02, -3.0513e-02, -2.9496e-02, -2.5407e-02, -1.8350e-02,
                                -1.8999e-02, -9.2775e-02, -2.3965e-02, -4.8959e-02, -2.0310e-02,
                                -3.3620e-02, -2.2776e-02, -3.0325e-02, -9.3272e-03, -3.7527e-02,
                                -3.0616e-02, -2.4505e-02, -2.9817e-02, -2.5446e-02, -2.5751e-02,
                                -2.4316e-03, -2.2945e-02, -3.7579e-02, -3.4046e-02, -2.2344e-02,
                                -2.3241e-02, -1.5243e-02, -3.0514e-02, -7.1480e-02, 1.6486e-03,
                                -8.7831e-03, -2.0463e-02, -1.6723e-02, -2.2194e-02, -1.7035e-02,
                                -3.3687e-02, -2.2181e-02, -3.9028e-02, -2.7853e-02, -2.8707e-02,
                                -2.7757e-02, -2.6136e-02, -1.0091e-02, -1.7252e-02, -4.0752e-02,
                                -3.4206e-02, -2.1177e-02, -1.5627e-02, -5.6535e-02, -3.5723e-02,
                                -1.5191e-02, -1.2301e-02, -7.2188e-04, 4.2061e-02, -1.2372e-02,
                                -3.5098e-02, -5.6407e-02, -1.6659e-02, -1.6425e-02, -3.5681e-02,
                                -1.5616e-02, -2.9628e-02, -4.2913e-02, 1.1900e-03, -1.0215e-02,
                                -2.6813e-02, -2.0887e-02, -5.8050e-03, -3.3738e-02, -2.1825e-02,
                                -4.1017e-03, -1.6975e-02, -8.7163e-03, -1.9493e-02, -1.5721e-02,
                                -3.0950e-02, -6.0824e-03, -1.3705e-02, -3.2635e-02, -1.3551e-02,
                                -1.4107e-04, -3.7299e-02, -2.0434e-02, -2.0545e-02, -3.1613e-02,
                                -3.0851e-02, 8.6760e-02],
                               [3.7840e-02, 4.2564e-02, 4.9734e-02, -3.0540e-02, 4.8941e-02,
                                2.3853e-01, 4.6462e-02, 3.7501e-02, 9.3522e-03, 4.1052e-02,
                                5.2422e-02, -5.5560e-02, 2.4746e-02, 4.7699e-02, -3.1342e-02,
                                2.2090e-02, 1.4782e-02, 5.3899e-03, 3.1353e-02, 3.6225e-02,
                                2.6383e-02, 3.1543e-02, 1.9978e-02, 4.1994e-02, 4.1563e-02,
                                2.6615e-02, 3.7467e-02, 3.1630e-02, 1.3736e-02, 3.3011e-02,
                                2.1187e-02, 2.4623e-02, 5.2896e-02, 3.3689e-02, 2.2101e-02,
                                2.6021e-02, 1.8018e-02, 3.0821e-02, 1.7948e-02, 1.6716e-02,
                                1.5829e-02, 2.9303e-02, 1.1890e-02, 4.4676e-02, 4.3152e-02,
                                2.6955e-02, 4.3942e-02, 3.6593e-02, 4.5093e-02, 3.2633e-02,
                                -2.1807e-03, 4.1655e-02, 3.5945e-02, 4.1513e-02, 2.1328e-02,
                                2.8561e-02, 2.6598e-02, 1.7520e-02, 3.0344e-02, 2.4928e-02,
                                3.8510e-02, 4.0013e-02, 2.2158e-02, 3.0758e-02, 4.5447e-02,
                                1.5313e-02, 3.1730e-02, 2.4489e-02, 4.2069e-02, -3.9307e-02,
                                1.3337e-02, 5.1199e-02, 2.3490e-02, -3.7948e-01, 4.2408e-02,
                                5.2260e-03, 1.9715e-02, 2.4188e-02, 2.8129e-02, 1.9116e-02,
                                2.2096e-02, 1.6142e-02, 3.4873e-02, 2.8660e-02, 4.4675e-03,
                                3.1020e-02, 4.3900e-02, 2.3455e-02, 4.9988e-02, 1.4866e-02,
                                2.7505e-02, -1.9593e-03, 8.1872e-03, 4.4582e-02, 3.0580e-02,
                                2.3545e-02, 3.9490e-02, 1.8779e-02, 2.8804e-02, 1.9287e-02,
                                4.5713e-02, 3.4684e-02, 4.9688e-02, -1.4959e-01, 1.6037e-02,
                                3.7011e-02, 2.5899e-02, 2.6094e-02, 1.5997e-02, 2.8798e-02,
                                2.8408e-02, 2.4196e-01, 3.2131e-02, 2.5947e-02, 1.9827e-02,
                                9.4326e-03, 5.0420e-02, 6.4682e-03, 3.0198e-02, 2.3092e-02,
                                4.4948e-02, 3.7013e-02, 2.1313e-02, 4.9944e-02, 1.6651e-02,
                                4.5519e-02, 3.2764e-02, 2.6098e-02, 3.9621e-02, 4.4654e-02,
                                4.6789e-02, 1.2499e-02, 3.8987e-02, -4.4293e-02, 3.3097e-02,
                                2.5656e-02, 4.1610e-02, 4.9813e-03, 4.5189e-02, 5.8042e-02,
                                1.2904e-02, 4.3059e-02, -2.1361e-03, 2.6552e-02, 1.6691e-02,
                                2.2621e-02, 5.2259e-03, 1.0044e-02, 2.8079e-02, 1.3767e-02,
                                1.5578e-02, -4.5917e-03, 3.3819e-02, 2.2187e-02, 4.0359e-02,
                                3.2275e-02, 2.2431e-02, 3.1986e-02, 6.0846e-02, 2.1343e-02,
                                2.9718e-02, 5.9706e-03, 2.2956e-02, 2.8963e-02, 3.5508e-02,
                                4.2021e-02, 1.6872e-02, 3.0855e-02, 2.4702e-02, 2.6305e-02,
                                1.4717e-02, 1.4658e-02, 1.2085e-02, 7.7087e-03, 4.9734e-02,
                                9.6276e-03, 4.2938e-02, 3.2546e-02, 1.5236e-02, 3.5089e-02,
                                3.5451e-02, 1.8357e-02, 4.7596e-02, 2.0036e-02, 2.3063e-02,
                                2.8152e-02, 5.9074e-03, 1.5031e-02, 2.5645e-02, 2.2309e-02,
                                3.5564e-02, 1.2608e-01],
                               [1.8315e-03, -2.0843e-03, 7.2693e-05, -1.5618e-02, -4.9835e-03,
                                2.1756e-01, -4.7512e-03, 2.3093e-02, -8.8910e-03, 3.0389e-02,
                                -1.4139e-02, -8.8044e-02, 1.0379e-02, -9.2499e-03, -4.8636e-02,
                                2.8259e-02, 1.8046e-02, 1.4924e-03, 3.4709e-02, 6.9734e-03,
                                1.5304e-02, -1.7485e-03, 5.7393e-03, 1.8598e-02, 9.5396e-03,
                                -3.7015e-03, -1.5529e-03, 1.2683e-03, -4.9817e-03, -7.2679e-03,
                                9.0435e-03, 1.8434e-02, 4.8590e-04, 1.2653e-02, -1.0448e-02,
                                1.0066e-02, 1.2706e-02, 2.5799e-02, 1.9512e-02, -1.4485e-03,
                                5.2602e-03, -1.2583e-02, 1.0098e-02, 5.1484e-03, -5.9228e-03,
                                1.1258e-02, -1.2099e-02, 1.2534e-03, -1.4138e-03, 1.7188e-02,
                                -6.3351e-03, -5.5411e-03, 1.4556e-02, 2.2654e-02, 1.5874e-02,
                                3.2375e-02, 9.1435e-03, -1.6295e-03, 2.8982e-02, 5.6617e-03,
                                1.1723e-02, -7.5366e-03, 1.3801e-03, 2.0185e-02, 3.0851e-02,
                                1.0691e-02, -9.3019e-03, 2.2953e-02, 1.6994e-02, -5.6314e-02,
                                1.7183e-02, 1.6034e-02, 9.6720e-03, 1.5352e-01, 4.4696e-03,
                                2.3453e-02, -6.3940e-04, 3.0792e-02, 1.6778e-02, 1.3831e-02,
                                2.2879e-02, 5.1688e-03, 1.4406e-02, 2.3416e-02, 7.1298e-03,
                                -1.1497e-03, -1.0933e-02, 2.6443e-02, 5.7623e-03, 1.6190e-02,
                                1.4247e-02, -5.8586e-03, 3.0346e-02, -8.3811e-03, 3.7703e-03,
                                2.7880e-02, 1.3258e-02, 1.9986e-02, -1.1902e-02, 2.0140e-02,
                                -6.0720e-03, 1.2068e-02, 2.4794e-03, 2.7246e-02, 2.6280e-02,
                                5.9084e-03, 7.9432e-03, 1.1186e-02, 2.4175e-02, 1.6528e-02,
                                2.0779e-05, -2.8545e-01, 1.7693e-02, 7.3990e-03, 1.4209e-02,
                                2.2225e-02, 1.1814e-02, 1.4611e-02, 1.6852e-02, 1.4986e-03,
                                5.4766e-03, 3.6633e-03, 7.5842e-03, 1.1124e-02, 1.6392e-02,
                                1.6994e-02, -1.4842e-03, 1.5660e-02, 3.2684e-02, 2.2776e-03,
                                1.4633e-02, -2.7891e-04, 4.0553e-03, -1.1191e-02, -5.7134e-03,
                                1.5494e-02, 2.0012e-02, 1.4447e-02, 5.6704e-03, 1.3853e-03,
                                2.0389e-02, 4.9749e-03, -8.5933e-03, 3.7420e-04, 5.4034e-03,
                                1.0687e-03, 2.4542e-02, 7.3005e-03, 9.9506e-03, 3.8301e-03,
                                1.3998e-02, 1.0355e-02, 1.7394e-02, -3.9517e-03, 9.9003e-03,
                                1.2771e-02, 9.1034e-03, -6.5464e-04, 4.2491e-02, 3.3804e-03,
                                1.3998e-02, -2.5059e-03, 1.4042e-02, 2.2292e-03, 2.3501e-02,
                                -5.7980e-03, 3.1078e-02, -4.5532e-03, 2.0554e-02, 1.8948e-02,
                                2.0612e-02, 6.3899e-03, 1.7023e-02, 2.6993e-02, 2.1666e-02,
                                1.0472e-02, -8.1830e-03, 1.2277e-02, 1.0260e-02, 1.2855e-02,
                                2.1109e-02, 1.2268e-02, 1.9048e-02, 2.0441e-02, 2.8979e-02,
                                9.3871e-03, 1.5551e-02, 1.6343e-02, 1.6886e-02, 1.5181e-02,
                                -4.7002e-03, 2.8072e-01],
                               [-5.4471e-02, -4.0942e-02, -5.0770e-02, 2.4628e-02, -5.0769e-02,
                                -8.1671e-02, -4.4798e-02, -3.4121e-02, -1.6648e-02, -5.1843e-02,
                                -3.5134e-02, 3.4938e-02, -5.5065e-02, -4.5928e-02, -4.0041e-03,
                                -4.1445e-02, -3.4128e-02, -1.4314e-02, -6.1471e-02, -3.7902e-02,
                                -4.3490e-02, -2.3059e-02, -1.2578e-02, -4.4023e-02, -3.2338e-02,
                                -3.6201e-02, -3.0607e-02, -2.8420e-02, -3.5136e-02, -2.9283e-02,
                                -2.5272e-02, -5.3294e-02, -6.5007e-02, -4.0615e-02, -9.8485e-03,
                                -3.4811e-02, -3.1453e-02, -3.2942e-02, -3.7941e-02, -3.7674e-02,
                                -2.2107e-02, -3.6181e-02, -2.9912e-02, -3.9152e-02, -4.9227e-02,
                                -2.8541e-02, -4.3018e-02, -1.1946e-02, -5.7938e-02, -3.7244e-02,
                                8.0627e-03, -3.1554e-02, -5.3673e-02, -4.6036e-02, -2.6384e-02,
                                -5.1056e-02, -4.6819e-02, -1.0486e-02, -3.4089e-02, -3.7708e-02,
                                -4.0940e-02, -4.2580e-02, -5.9842e-03, -6.6048e-02, -7.4882e-02,
                                -2.7789e-02, -4.1016e-03, -6.0117e-02, -4.7000e-02, 1.7059e-02,
                                -3.7949e-02, -7.0349e-02, -2.1617e-02, 2.0445e-01, -2.5969e-02,
                                -2.2903e-02, -4.0350e-02, -4.8978e-02, -3.4550e-02, -5.7542e-02,
                                -2.9795e-02, -5.0280e-02, -5.0343e-02, -4.7010e-02, -3.5542e-02,
                                -2.4968e-02, -3.7565e-02, -3.0068e-02, -5.2791e-02, -2.1412e-02,
                                -4.4845e-02, 6.4889e-03, -4.1345e-02, -6.2010e-02, -3.9108e-02,
                                -3.0366e-02, -3.7489e-02, -5.1772e-02, -3.1138e-02, -4.3832e-02,
                                -6.4074e-02, -3.7120e-02, -4.4028e-02, 1.1826e-01, -2.7096e-02,
                                -3.9384e-02, -2.8453e-02, -3.7819e-02, -3.0706e-02, -3.4918e-02,
                                -5.2184e-02, 5.8887e-02, -3.7323e-02, -3.6221e-02, -3.2022e-02,
                                -2.3412e-02, -4.5506e-02, -2.2843e-02, -5.2383e-02, -1.9561e-02,
                                -4.4188e-02, -4.8406e-02, -3.1569e-02, -5.0948e-02, -2.2174e-02,
                                -3.5652e-02, -2.9947e-02, -3.8034e-02, -5.5650e-02, -5.2097e-02,
                                -5.1801e-02, -4.1747e-02, -6.6583e-02, 1.9180e-02, -3.0407e-02,
                                -3.3739e-02, -5.4197e-02, -5.0377e-02, -6.0329e-02, -5.5718e-02,
                                -3.0105e-02, -3.7748e-02, 1.5764e-02, -4.1041e-02, -4.0424e-02,
                                -2.1362e-02, -4.7912e-02, -2.5979e-02, -3.4419e-02, -2.8126e-02,
                                -3.4986e-02, -1.9232e-02, -5.8421e-02, -5.4149e-02, -5.3415e-02,
                                -4.2626e-02, -4.3849e-02, -2.7738e-02, -6.0662e-02, -2.4560e-02,
                                -2.7981e-02, -2.1219e-02, -5.3506e-02, -3.9636e-02, -5.4719e-02,
                                -4.3214e-02, -4.4958e-02, -3.2243e-02, -5.0279e-02, -3.4126e-02,
                                -2.4075e-02, -3.0557e-02, -3.0838e-02, -1.9630e-02, -5.5796e-02,
                                -3.6681e-02, -4.9014e-02, -4.2436e-02, -4.5311e-02, -3.4942e-02,
                                -4.6206e-02, -1.7965e-02, -6.3607e-02, -5.2213e-02, -2.9873e-02,
                                -2.7473e-02, -2.5343e-02, -2.6075e-02, -8.1838e-03, -5.5985e-02,
                                -4.4631e-02, -6.6456e-01]]])

        z = token
        for i in range(b - 1):
            z = torch.cat((z, token), dim=0)

        x = self.bneck(self.stem(x))
        for m in self.block:
            x, z = m(x, z)

        # 转成b个平铺一维向量
        x = self.avg(self.bn(self.conv(x))).view(b, -1)
        # 取第一个token
        z = z[:, 0, :].view(b, -1)
        # 最后一个维度拼接
        out = torch.cat((x, z), -1)

        out = self.head1(out)
        out = self.tanh(out)
        out = self.head2(out)
        return out
