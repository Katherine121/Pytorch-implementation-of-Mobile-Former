import torch
import torch.nn as nn

from torch.nn import init
import torch.nn.functional as F

from mobile_former.mobile import Mobile, MobileDown
from mobile_former.former import Former
from mobile_former.bridge import Former2Mobile


class hswish(nn.Module):
    def forward(self, x):
        out = x * F.relu6(torch.add(x, 3.0)) / 6.0
        return out


class BaseBlock(nn.Module):
    def __init__(self, inp, exp, out, se, stride, heads, dim):
        super(BaseBlock, self).__init__()
        if stride == 2:
            self.mobile = MobileDown(3, inp, exp, out, stride)
        else:
            self.mobile = Mobile(3, inp, exp, out, stride)
        self.former = Former(dim=dim)
        self.former2mobile = Former2Mobile(dim=dim, heads=heads, channel=out)

    def forward(self, x, z):
        z_out = self.former(z)
        x_hid = self.mobile(x)
        x_out = self.former2mobile(x_hid, z_out)
        return x_out, z_out


class MobileFormer(nn.Module):
    def __init__(self, cfg):
        super(MobileFormer, self).__init__()
        # 初始化6*192token
        self.token = nn.Parameter(nn.Parameter(torch.randn(1, cfg['token'], cfg['embed'])))

        # stem 3 224 224 -> 16 112 112
        self.stem = nn.Sequential(
            nn.Conv2d(3, cfg['stem'], kernel_size=3, stride=2, padding=1, bias=False),
            nn.BatchNorm2d(cfg['stem']),
            hswish()
        )
        # bneck 先*2后还原，步长为1，组卷积
        self.bneck = nn.Sequential(
            nn.Conv2d(cfg['stem'], cfg['bneck']['e'], kernel_size=3, stride=cfg['bneck']['s'], padding=1,
                      groups=cfg['stem']),
            hswish(),
            nn.Conv2d(cfg['bneck']['e'], cfg['bneck']['o'], kernel_size=1, stride=1),
            nn.BatchNorm2d(cfg['bneck']['o'])
        )

        # body
        self.block = nn.ModuleList()
        for kwargs in cfg['body']:
            # 把{'inp': 12, 'exp': 72, 'out': 16, 'stride': 2, 'heads': 2}和token维度192传进去
            self.block.append(BaseBlock(**kwargs, dim=cfg['embed']))

        inp = cfg['body'][-1]['out']
        exp = cfg['body'][-1]['exp']
        self.conv = nn.Conv2d(inp, exp, kernel_size=1, stride=1, padding=0, bias=False)
        self.bn = nn.BatchNorm2d(exp)
        self.avg = nn.AvgPool2d((7, 7))

        self.head1 = nn.Linear(exp + cfg['embed'], cfg['fc1'])
        self.tanh = hswish()
        self.head2 = nn.Linear(cfg['fc1'], cfg['fc2'])

        self.init_params()

    def init_params(self):
        for m in self.modules():
            if isinstance(m, nn.Conv2d):
                init.kaiming_normal_(m.weight, mode='fan_out')
                if m.bias is not None:
                    init.constant_(m.bias, 0)
            elif isinstance(m, nn.BatchNorm2d):
                init.constant_(m.weight, 1)
                init.constant_(m.bias, 0)
            elif isinstance(m, nn.Linear):
                init.normal_(m.weight, std=0.001)
                if m.bias is not None:
                    init.constant_(m.bias, 0)

    def forward(self, x):
        # batch_size
        b = x.shape[0]
        # 因为最开始初始化的是1*6*192，在0维度重复b次，1维度重复1次，2维度重复1次，就形成了b*6*192
        # z = self.token.repeat(b, 1, 1)
        z = torch.Tensor([[[-1.0189e+00, -2.0822e+00, 4.5158e-01, -7.3884e-01, 2.9207e+00,
                            4.3277e-01, 1.1868e+00, 4.3290e-01, -3.0451e-01, 5.0535e-01,
                            1.3491e+00, 6.1179e-01, 9.2741e-01, 4.7696e-02, 1.0240e+00,
                            -3.8355e-01, -5.9031e-01, -5.8158e-01, 6.7067e-01, 9.8440e-01,
                            1.0571e+00, -7.0830e-01, 1.5210e-02, -2.8824e-01, -1.8083e+00,
                            6.0050e-01, 9.9295e-01, 7.4221e-01, 4.2169e-01, 2.4339e-01,
                            6.2033e-01, -2.5337e-01, 1.1685e+00, 3.8127e-01, -1.1703e+00,
                            -1.1954e+00, 1.5430e-01, -2.0292e-01, 1.3552e+00, 5.5391e-01,
                            2.5994e-01, 1.4556e+00, 8.3179e-01, 1.9528e+00, -9.5150e-01,
                            -1.0368e+00, 9.8283e-01, 3.5924e-01, -3.3474e-02, -5.3310e-01,
                            2.9162e-01, 6.9703e-01, 7.7562e-01, 1.1788e+00, 1.4519e+00,
                            2.4838e-01, -1.6847e+00, 2.0868e-01, -1.1964e+00, -3.0630e+00,
                            -1.1661e+00, 4.0725e-01, 1.1523e+00, -4.6091e-01, 4.4072e-01,
                            5.1355e-01, -9.2446e-01, -1.5493e-01, -4.7520e-01, -1.0323e-01,
                            -4.2972e-01, 7.3929e-03, 1.2428e+00, 8.1274e-01, 1.4823e-02,
                            -1.0871e+00, -1.6339e-01, 1.3013e+00, 1.1989e+00, 3.5156e-01,
                            -5.4401e-01, 1.1052e+00, -1.5830e+00, -1.0054e+00, -5.5966e-01,
                            6.8404e-01, -6.0481e-01, -2.1100e+00, 1.1683e+00, 5.8969e-01,
                            8.8932e-01, -8.9337e-01, -9.8694e-01, 1.3622e+00, -1.2631e-01,
                            9.5623e-02, 2.2991e+00, -4.9338e-01, 1.6259e-01, -8.4380e-01,
                            5.5015e-01, 9.4316e-01, -1.1484e+00, 1.4421e-01, 3.0641e-01,
                            4.4843e-01, 1.2323e+00, 1.1647e+00, 3.1422e-01, -1.5589e+00,
                            -2.9354e-01, -6.8893e-01, 2.9901e-01, -2.4105e+00, 1.1804e+00,
                            -1.8656e-01, -1.1979e+00, -1.1664e+00, 1.1559e+00, 1.0072e+00,
                            -9.8139e-01, 8.2690e-01, 8.8472e-02, 2.9405e-01, 3.1394e-01,
                            5.0580e-01, -1.9849e+00, -9.8718e-01, 7.4290e-01, -3.2899e-01,
                            -2.2618e+00, -1.6391e-01, 7.8479e-01, 6.0285e-01, 2.1623e+00,
                            -8.0486e-02, 1.6965e+00, 6.3701e-02, -9.1925e-01, 3.8432e+00,
                            4.9022e-02, -8.2575e-01, 4.0975e-01, 1.4537e+00, -6.4124e-01,
                            -1.2068e+00, -1.9261e+00, -1.4968e+00, -9.4197e-01, -2.4222e-01,
                            -1.5102e-01, -6.1693e-01, 8.9061e-01, 2.2158e+00, 2.2116e+00,
                            1.3267e+00, -2.8601e-01, 4.9115e-01, 7.6777e-01, 1.8909e+00,
                            -3.7942e-02, -7.7632e-01, -6.3187e-01, -3.5098e-01, -6.9533e-01,
                            6.9689e-01, 5.0312e-02, 1.5623e-01, 9.8311e-01, -2.2658e-02,
                            9.3535e-02, -4.9057e-01, -1.2330e+00, -1.0306e+00, 2.4731e+00,
                            -7.0821e-01, -1.0971e-01, -9.9072e-01, 4.0400e-01, 3.0653e-01,
                            3.2771e-01, -2.2659e-02, -1.2240e+00, -2.6816e-01, 1.1614e+00,
                            8.7979e-02, -3.4219e-01, 2.0155e+00, 5.0911e-01, 5.3098e-01,
                            1.8871e-01, 7.0475e-01],
                           [-9.0345e-01, -1.5275e+00, 1.0447e+00, -1.4873e+00, -2.4921e+00,
                            -3.0511e-01, 1.1338e+00, 1.3850e+00, 1.2915e+00, 1.1432e+00,
                            2.8687e-02, 1.6836e-01, -9.5433e-01, -4.3915e-01, 6.4149e-01,
                            4.9910e-01, -1.1987e+00, -8.9855e-01, 1.0129e+00, -1.3891e+00,
                            1.0610e+00, 2.1114e+00, -1.4347e+00, 3.4403e+00, 1.0552e+00,
                            -6.0036e-02, 3.3461e-01, 1.4909e-01, -6.9033e-01, 1.6050e+00,
                            -6.7846e-01, 1.1523e+00, 1.8661e+00, 9.1682e-01, 5.3437e-01,
                            -7.4905e-02, -1.2953e+00, -4.6726e-01, -6.6731e-01, 4.4272e-01,
                            1.3073e+00, 1.5453e+00, 9.5424e-01, 1.5796e+00, 8.1091e-01,
                            7.2419e-01, 2.1672e+00, -3.7818e-01, 8.4429e-01, -9.2305e-01,
                            -2.0328e+00, -3.8534e-01, -1.3404e+00, 1.2581e+00, -2.1688e+00,
                            -6.3762e-01, -1.5348e-01, -8.2184e-01, -9.2257e-01, -1.1569e+00,
                            -5.6104e-01, -1.2436e+00, -4.3328e-01, 5.5794e-01, 6.8204e-01,
                            1.5333e+00, 8.1597e-01, -5.8516e-01, -1.1759e+00, 2.5512e-01,
                            5.7048e-01, 4.6127e-01, 5.0491e-01, 2.9177e-01, 4.0478e-01,
                            8.9344e-01, 7.3275e-01, -8.3748e-01, -3.8920e-01, 9.5124e-01,
                            -2.8672e-01, 5.7307e-01, 1.8001e+00, -1.3690e+00, -1.5088e+00,
                            -2.1853e+00, -1.0264e+00, -8.3486e-01, 9.8538e-01, 7.8942e-01,
                            1.4474e+00, -2.2661e+00, -1.5478e+00, 2.4002e-01, -9.4359e-01,
                            2.4127e-01, -1.0925e+00, -2.2905e+00, 7.9919e-01, -9.7820e-01,
                            5.3880e-01, 7.2895e-01, -9.0441e-01, 5.4254e-01, -5.8066e-01,
                            8.7620e-01, 1.9146e-01, -1.0010e+00, 1.9339e-01, 5.8739e-01,
                            -6.5308e-01, 1.1160e+00, -6.5642e-01, 1.1062e-01, -2.0891e-02,
                            2.3960e-02, 6.3496e-01, -2.6972e-01, 5.1207e-01, 3.6781e-01,
                            -8.6892e-01, -1.1561e+00, 1.6044e-01, 5.1379e-01, -3.2949e-01,
                            -2.4464e-01, -4.4013e-02, 1.6848e-02, -2.0216e+00, 9.5818e-01,
                            -1.0653e+00, -7.6038e-01, 1.5270e+00, -1.0655e+00, 3.2817e-02,
                            8.8284e-01, 8.5424e-01, 5.8637e-01, -4.7518e-02, -1.2504e+00,
                            1.8037e+00, 3.5998e-01, -1.3439e-01, -1.4535e+00, -1.1117e+00,
                            7.4822e-01, -4.1335e-01, -1.3186e-01, -3.7307e-01, -2.2575e+00,
                            1.6939e+00, -1.4512e+00, -1.3137e-01, -2.0601e-01, -7.9377e-01,
                            -2.9896e-01, 1.8213e+00, 6.2854e-02, -5.7257e-01, 7.4719e-01,
                            -3.8697e-01, -2.0810e-01, -4.7568e-01, 2.1482e-01, -1.9188e+00,
                            -1.3289e-01, 2.4862e-01, 7.5185e-01, -1.9715e-01, -3.3755e-01,
                            5.2225e-01, -9.2391e-01, 1.6170e-01, 4.0213e-01, -1.7768e+00,
                            -7.0890e-01, -7.2658e-01, 1.0671e+00, 1.3097e+00, 1.1560e-02,
                            5.1204e-01, 1.3150e-01, 8.6605e-01, -1.1569e-01, -8.9921e-01,
                            -1.3936e+00, -1.3655e+00, 5.1314e-02, -1.8712e-01, 1.0780e+00,
                            1.1037e-01, 2.5813e+00],
                           [1.4777e+00, -1.3757e+00, -6.6053e-01, 1.7487e+00, 4.5890e-01,
                            -4.8082e-01, 1.0956e+00, -8.7748e-02, 1.2635e+00, -6.1493e-01,
                            -3.5514e-01, -1.0687e+00, -1.3851e+00, -1.4057e+00, 1.8636e+00,
                            -1.1615e+00, 2.9359e-01, 2.5686e-01, -1.0681e+00, 1.5605e+00,
                            -1.0350e+00, -9.9446e-01, -6.3435e-01, 7.1286e-01, 1.4306e+00,
                            -6.9041e-02, -6.1353e-01, 5.5829e-02, 1.2082e+00, -8.8720e-02,
                            -1.1341e+00, 1.0350e+00, 1.2119e+00, 7.0066e-01, 8.8409e-01,
                            2.2960e-01, -3.2872e-01, 1.1534e+00, -3.3050e-02, 1.0856e-01,
                            -1.7610e+00, 1.4539e+00, 7.0233e-02, 1.3232e+00, -7.7339e-01,
                            -1.3961e+00, 7.3347e-01, -6.4280e-01, -1.2759e+00, 5.3436e-01,
                            -1.2967e+00, -2.0777e-01, -1.9247e-01, -1.2886e+00, 5.0924e-01,
                            2.0443e-01, -6.9771e-02, -1.8079e+00, -9.2350e-02, -9.9385e-01,
                            3.5384e-01, 7.4407e-01, 1.0696e+00, -1.6976e-01, 1.0038e+00,
                            9.9009e-01, -2.1781e-02, -3.7906e-01, 1.5593e+00, -3.6831e-01,
                            6.1718e-01, -2.7933e-02, -7.0971e-01, 5.0899e-01, -8.9657e-01,
                            2.3646e-01, -5.2422e-01, -1.1370e+00, -1.2006e+00, -5.7421e-01,
                            8.4249e-01, -1.0566e+00, 5.7128e-02, -7.4850e-01, 1.0427e+00,
                            -1.6893e-01, 1.4157e+00, 8.2437e-01, -9.7931e-01, -3.3760e-01,
                            8.7583e-01, -5.1189e-01, 1.5219e+00, 1.6311e+00, 1.7373e+00,
                            -7.3423e-01, -1.4515e-01, 7.5944e-01, 7.0546e-01, 6.0977e-01,
                            -5.0220e-01, -2.8906e+00, -2.0570e+00, -9.4448e-01, 1.1601e+00,
                            -1.2645e-01, 1.4863e+00, 8.4815e-01, 2.3266e+00, 8.6722e-01,
                            -1.8048e+00, -1.6398e+00, 5.8136e-01, -3.6907e-01, -5.2903e-01,
                            3.2060e-01, 3.7806e-01, 1.3848e+00, 1.4272e+00, -1.8161e-01,
                            6.1764e-01, 2.1038e+00, 1.2165e+00, -2.7357e-01, 3.8231e-01,
                            -5.3439e-01, -2.1672e-02, -8.2253e-01, -9.4046e-01, -1.3940e+00,
                            4.3028e-01, -3.3819e-01, 9.0709e-03, 7.5973e-01, -7.7572e-01,
                            -4.7650e-01, -3.2050e-01, 1.5879e+00, 6.1893e-01, 2.4465e-01,
                            8.2508e-01, -6.0901e-01, -1.8957e+00, -5.0112e-01, -6.9023e-01,
                            -2.2481e-01, 7.8464e-01, -1.9728e+00, -1.0210e+00, 1.1953e+00,
                            -7.0903e-01, 3.3132e-01, 1.5045e-01, -1.8004e-01, -2.5174e-01,
                            1.6155e-01, -7.9372e-01, 4.0717e-01, -1.7441e+00, -1.3090e+00,
                            -7.3991e-03, -1.1376e+00, -8.0081e-02, 6.7650e-01, 1.8117e+00,
                            5.5113e-01, -2.4343e+00, -5.4364e-01, -1.0055e-01, -9.6248e-01,
                            -3.8632e-01, 2.6089e-01, 1.6707e+00, -4.5692e-01, 2.3612e-01,
                            1.9752e-01, 1.0716e+00, -3.0065e-01, 4.3432e-01, 2.1507e-01,
                            7.4290e-02, -2.6244e+00, 4.9362e-01, 1.6942e+00, 2.2670e-01,
                            1.3675e+00, -1.0392e+00, 2.6238e-01, 3.5298e-01, -2.9237e-01,
                            1.3598e-01, 5.5067e-01],
                           [-7.9970e-01, -2.5692e-01, -1.2117e+00, 2.1821e+00, 5.0593e-01,
                            1.1217e-01, -1.5840e+00, -5.5550e-01, 2.2783e-01, -1.6247e-01,
                            1.2579e+00, 1.2724e+00, 1.4977e+00, 6.8633e-01, 2.8489e-01,
                            1.6090e+00, 3.8789e-01, -9.3667e-01, 1.3838e+00, -1.0436e+00,
                            1.8802e+00, -8.5276e-01, -1.0936e+00, 2.7872e-01, 5.8645e-01,
                            8.8200e-01, 5.5577e-01, -3.5598e-01, 1.1643e+00, -2.5694e-01,
                            5.6678e-01, 1.8048e+00, -8.6745e-01, -3.3309e-01, -5.4733e-02,
                            -6.4669e-01, 4.1736e-01, -1.2508e+00, -1.8703e-01, -3.2405e-01,
                            9.8337e-01, -1.0548e+00, -1.1113e+00, -1.3433e-01, -1.3455e-01,
                            1.0752e+00, -3.4927e-01, 1.0180e-01, 2.9888e-01, -1.0808e+00,
                            4.8283e-01, 9.3049e-01, -9.3155e-01, 1.4207e-01, -1.0213e+00,
                            1.1413e+00, 1.9654e+00, -8.1230e-01, 2.3424e-01, 2.5323e-01,
                            1.7418e+00, -2.6256e+00, 7.0586e-01, 2.2145e-03, -2.5398e-01,
                            -1.6010e-01, 1.1794e-01, 2.6132e-01, -2.1207e+00, -2.5014e-01,
                            2.2076e+00, 2.1393e+00, 9.1629e-01, -9.1337e-02, 8.2393e-02,
                            -1.8412e+00, -7.7097e-01, -7.7894e-01, 1.6922e+00, -1.3864e+00,
                            -1.0503e+00, 6.7270e-01, 6.5387e-01, -5.6546e-01, 3.7254e-01,
                            5.0523e-01, 4.9201e-02, -7.0755e-01, 1.6226e-01, -2.6673e-01,
                            -5.0455e-01, -2.5705e-01, 1.7831e-02, -5.0544e-01, 9.7710e-01,
                            -5.1743e-02, -1.7639e+00, 5.9958e-01, 1.2286e+00, -5.0509e-01,
                            -3.3592e-01, 2.3630e-01, -1.2780e+00, 8.1030e-01, 8.4934e-01,
                            8.1366e-03, -1.4262e-01, -9.6533e-01, -1.5194e+00, -1.2132e+00,
                            7.3303e-01, 8.5193e-01, 4.0066e-01, 4.5390e-01, 1.1736e+00,
                            1.2214e+00, 8.1332e-01, -5.4909e-01, -2.5739e-01, -1.1357e+00,
                            -8.1060e-01, 1.1709e+00, 2.9902e-01, -2.0565e-01, 2.6520e+00,
                            -1.0773e+00, 9.5685e-01, 1.0416e+00, -1.9261e-01, -9.3866e-01,
                            1.9346e-01, -4.3625e-03, 1.0599e+00, -1.1321e-02, -1.4659e+00,
                            -2.3771e-01, -9.8827e-01, 6.9193e-02, -5.4682e-01, 9.6355e-01,
                            4.5659e-01, 1.0146e+00, -1.5807e+00, 1.8273e+00, 3.5300e-01,
                            -4.2499e-01, -1.7016e+00, 5.9038e-01, -5.4704e-01, -1.0129e+00,
                            9.8938e-01, 4.1233e-01, 1.2306e+00, -1.3474e-01, -1.9281e+00,
                            -3.3923e-01, -1.1647e+00, 5.9548e-02, 7.5326e-01, -4.9185e-01,
                            -7.3855e-01, 5.3132e-01, 8.3349e-01, -8.6378e-01, -6.7780e-01,
                            5.7097e-01, -9.1641e-01, 5.8198e-01, -8.0191e-01, -7.6885e-01,
                            6.9781e-01, 1.0266e+00, -1.6035e+00, 2.0385e-01, 2.2753e+00,
                            -5.0950e-01, 1.2853e+00, 1.3322e+00, 3.5577e-01, -8.7696e-01,
                            3.7565e-01, -9.5885e-01, -1.5028e+00, 2.9547e-01, -8.8480e-01,
                            1.9450e-01, -1.6448e+00, -6.0352e-01, -7.1381e-01, -1.0926e+00,
                            -1.7050e+00, 4.0707e-01],
                           [-7.0269e-02, -1.1133e+00, 6.4171e-01, -4.0844e-01, 7.3879e-02,
                            6.4522e-01, -5.7977e-01, -1.1269e-01, 1.3790e+00, -1.4778e+00,
                            -1.3961e+00, 3.5752e-01, -1.4394e+00, -4.4762e-01, -1.9627e+00,
                            1.1039e+00, -1.0697e+00, -8.1124e-01, 8.6827e-01, -3.6823e-02,
                            7.8458e-01, 1.4319e-01, -6.5385e-01, -9.3630e-02, -6.3692e-01,
                            -5.8384e-02, 7.4098e-01, 1.0750e+00, -2.8355e-01, -1.4055e+00,
                            1.6567e-01, -4.0535e-01, 2.8258e-01, 3.7970e-01, 9.0971e-01,
                            1.0146e+00, -1.9436e+00, -6.4379e-01, -9.8552e-01, -2.2374e+00,
                            -1.0536e-01, -3.7232e-01, -3.5007e-01, 6.9373e-01, -9.7659e-01,
                            -1.6281e+00, -1.0622e+00, 1.4379e+00, 1.4238e+00, 3.5547e-01,
                            6.0703e-01, 7.6452e-01, -5.7387e-01, -1.1366e+00, -3.3196e-01,
                            4.9200e-01, -1.6709e+00, 6.4052e-01, 6.3814e-01, -8.3712e-01,
                            -8.5526e-01, -1.0071e+00, -6.4970e-01, -7.7794e-01, 6.9673e-01,
                            -2.7621e-01, -1.0169e+00, 1.4876e+00, -7.6894e-01, 7.3625e-01,
                            2.2678e-01, 1.4030e+00, -3.7987e-02, 7.4066e-01, 9.4635e-01,
                            -1.2296e+00, 5.2545e-01, -5.9828e-01, -3.1202e-01, -5.0004e-01,
                            -7.0302e-01, -1.0009e+00, -1.0404e+00, 8.2651e-01, 1.0197e-01,
                            2.4329e+00, 1.7317e+00, -5.2374e-01, -5.1139e-01, 8.1105e-03,
                            8.3420e-01, -2.4648e-01, -2.6940e-01, -2.1455e+00, -2.8295e-01,
                            -3.9696e-01, -7.5643e-01, -1.4692e+00, -1.2755e+00, -6.7761e-01,
                            9.4257e-01, -1.2373e+00, 2.9208e-01, -6.7782e-01, -1.9735e-01,
                            -5.7958e-01, 9.7810e-01, -1.2078e+00, -5.7491e-01, 7.1985e-02,
                            -9.7666e-02, -6.6535e-01, -5.4267e-01, -3.1468e-01, -6.4876e-01,
                            1.2408e-01, 4.9333e-01, 2.1357e-01, -8.3098e-01, -1.2463e+00,
                            3.3875e-01, 9.6950e-01, -3.4498e-01, -1.9323e+00, -1.0354e+00,
                            2.1795e-01, 1.8096e-01, 2.7041e-02, -1.3914e-01, 7.2582e-01,
                            2.2748e-01, -5.0130e-02, -5.0409e-01, 1.3222e+00, -9.8250e-01,
                            -8.4214e-01, 1.0787e+00, 1.3817e+00, -7.4535e-01, -6.4750e-01,
                            1.1623e+00, -1.4942e+00, -1.3822e-01, -2.8715e+00, 1.4600e+00,
                            1.1021e+00, -2.1953e-01, 2.1240e-01, -7.8384e-01, -8.8369e-01,
                            -7.7434e-01, -5.2385e-01, 1.7990e+00, -1.4631e+00, 2.4203e+00,
                            1.4785e+00, -1.9254e+00, -5.8314e-01, 1.2665e+00, -4.5285e-01,
                            -7.2948e-02, -1.3438e+00, -1.2403e+00, -1.1374e+00, -2.0978e-01,
                            1.0390e+00, 1.0722e+00, -9.5032e-01, -1.3038e+00, -6.9551e-01,
                            -9.5683e-02, -2.5261e-02, -4.9902e-01, 1.3451e-01, -5.7958e-01,
                            5.6261e-01, 7.3922e-01, -8.9466e-01, -1.1116e+00, -1.9729e+00,
                            1.7820e-01, 6.7713e-01, -8.3379e-01, -3.2034e-01, -3.2439e-01,
                            -9.9797e-01, 1.8143e+00, 3.9101e-01, -2.7242e-01, -2.0799e-01,
                            9.6691e-01, 3.1168e-01],
                           [6.7986e-01, -4.6991e-01, 2.7779e-01, 1.1919e+00, 2.0101e+00,
                            -2.0755e+00, 9.0203e-01, 1.0409e+00, 8.1568e-01, 8.5703e-01,
                            -1.3477e+00, 1.5462e-01, -4.3395e-02, -1.2180e-01, 6.5115e-01,
                            9.5765e-02, -2.5564e-01, -8.8659e-01, -7.7518e-01, -9.7141e-01,
                            1.1222e+00, 3.9086e-01, 2.7099e-01, -9.9417e-01, -1.3143e-01,
                            -7.2202e-01, -1.2857e+00, 1.1528e+00, -6.2244e-02, 1.1876e+00,
                            -3.5633e-02, -7.6754e-01, -2.1596e+00, -1.7444e+00, -6.5706e-01,
                            1.0555e+00, 1.4223e-01, -6.5308e-01, -5.9114e-01, 2.2255e-01,
                            6.7817e-01, -1.1676e+00, 1.2385e+00, 6.8438e-01, 8.2615e-01,
                            -2.2958e+00, 7.3424e-01, 8.5270e-02, -5.7811e-01, -1.0102e+00,
                            -4.2995e-01, -3.3347e-01, -6.1509e-01, -7.1172e-01, -9.0702e-01,
                            1.4926e+00, -2.0174e+00, -9.0069e-01, -3.2515e-01, -1.7537e-01,
                            -1.0132e+00, -1.2399e+00, -3.8877e-01, 7.5753e-01, -5.6523e-01,
                            -1.1995e+00, 1.5766e+00, -8.9953e-01, -7.6923e-01, 8.3160e-01,
                            8.7806e-01, 1.2270e-01, -3.5736e-02, 1.0834e-01, 3.3110e-01,
                            3.5860e-01, 7.7374e-01, 4.6735e-02, -5.2356e-01, 2.4423e+00,
                            3.6201e-01, -9.7854e-01, -2.2207e+00, -3.3054e-01, 1.8165e+00,
                            4.0584e-02, 4.7133e-01, 4.1911e-01, 1.9748e+00, 1.5145e+00,
                            1.0558e+00, 1.5199e-01, -6.2103e-01, 1.4866e+00, 1.0216e+00,
                            1.0509e+00, -9.8352e-01, 1.0155e+00, 1.4484e+00, -1.4495e+00,
                            -8.6053e-01, 3.1424e-01, 5.0689e-01, -1.8852e+00, 1.1521e+00,
                            -1.8534e+00, -7.3922e-01, 1.4010e+00, -4.3615e-01, 1.5910e-01,
                            -5.2026e-01, -7.3812e-01, 9.7940e-01, 1.5443e+00, -2.5902e+00,
                            1.1013e+00, 4.9143e-01, 4.7393e-01, -1.1885e+00, 1.6533e+00,
                            8.4706e-01, -7.4010e-01, 1.0289e+00, 8.3766e-02, -1.4153e+00,
                            5.2602e-01, 1.0539e+00, 6.5200e-01, 1.0598e+00, -2.2107e-01,
                            -1.4731e-01, -3.6431e-01, 1.5344e-01, -8.4044e-01, 2.5539e-01,
                            7.6719e-01, 8.8145e-01, 7.0391e-02, -1.5835e+00, 5.7136e-01,
                            -1.3792e+00, 4.8279e-01, -1.4654e-02, 7.7616e-01, 3.0790e-02,
                            6.9967e-01, -6.3054e-01, 1.0102e+00, -1.5364e+00, 1.5176e+00,
                            9.9012e-01, -4.7135e-01, 6.6835e-01, -4.5176e-01, 6.6489e-02,
                            -2.4008e+00, -1.9441e-01, 1.3717e+00, 2.2864e+00, -1.6316e+00,
                            -4.9484e-01, -8.0725e-01, 7.6236e-01, 1.6652e+00, -8.5162e-01,
                            -1.5342e+00, 6.4547e-01, -1.1719e+00, -1.5106e+00, -1.0856e+00,
                            -7.5775e-01, 7.4033e-02, 2.7161e-02, 2.6542e-01, -2.2773e+00,
                            -1.4951e+00, 1.5056e+00, -1.0001e+00, -5.3082e-01, 3.3980e-01,
                            -2.0922e-01, -6.7891e-01, -4.2132e-01, 7.2276e-02, -1.1813e+00,
                            6.4617e-01, -2.3995e-01, -1.3082e+00, -5.7667e-02, 5.1406e-01,
                            -1.0067e+00, -1.0404e+00]]])

        x = self.bneck(self.stem(x))
        for m in self.block:
            x, z = m(x, z)

        # 转成b个平铺一维向量
        x = self.avg(self.bn(self.conv(x))).view(b, -1)
        # 取第一个token
        z = z[:, 0, :].view(b, -1)
        # 最后一个维度拼接
        out = torch.cat((x, z), -1)

        out = self.head1(out)
        out = self.tanh(out)
        out = self.head2(out)
        return out
